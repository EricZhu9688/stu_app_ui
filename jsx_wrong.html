<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>错题攻克中心</title>
    <script src="js/tailwind.min.js"></script>
    <script src="js/lucide.js"></script>
    <link rel="stylesheet" href="js/components/SubjectSwitcher.css">
    <script src="js/components/SubjectSwitcher.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }

        .icon-small {
            width: 1rem;
            height: 1rem;
            stroke-width: 2.5;
        }

        .icon-base {
            width: 1.25rem;
            height: 1.25rem;
            stroke-width: 2;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal Animation */
        .modal-enter {
            animation: modalUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes modalUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Hide scrollbar for clean UI */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .card-selected {
            border-color: #09C0D7 !important;
            box-shadow: 0 0 0 2px rgba(9, 192, 215, 0.2) !important;
        }

        /* 顶部导航条重置 */
        #subject-tabs-container .subject-tab {
            color: rgba(255, 255, 255, 0.6) !important;
            font-size: 18px !important;
            font-weight: 500 !important;
            padding-bottom: 4px !important;
            position: relative;
        }
        #subject-tabs-container .subject-tab.active {
            color: #ffffff !important;
            font-weight: 700 !important;
        }
        #subject-tabs-container .subject-tab.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 4px;
            background: #ffffff;
            border-radius: 2px;
        }

        /* 胶囊按钮样式 */
        .capsule-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 999px;
            padding: 4px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(8px);
        }

        /* 细长呼吸进度条 */
        .breathing-bar {
            height: 4px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.2);
            overflow: hidden;
            display: flex;
        }
        
        .breathing-bar-inner {
            height: 100%;
            transition: width 1s ease-in-out;
        }

        /* 筛选芯片样式优化 */
        .filter-chip-row {
            display: flex;
            align-items: center;
            gap: 10px;
            overflow-x: auto;
            padding: 4px 0;
        }
        .filter-chip-item {
            background: #ffffff;
            color: #4b5563;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        .filter-chip-item:active {
            background: #f3f4f6;
            transform: scale(0.96);
        }

        /* 字体设计 */
        .stat-number {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            letter-spacing: -0.02em;
        }

        /* 悬浮按钮 (FAB) */
        .fab-container {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 40;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .fab-main {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #4F6BE4 0%, #6378D1 100%);
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-center: center;
            color: white;
            box-shadow: 0 8px 24px rgba(79, 107, 228, 0.4);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            justify-content: center;
        }

        .fab-main:active {
            transform: scale(0.9) translateY(4px);
            box-shadow: 0 4px 12px rgba(79, 107, 228, 0.3);
        }
    </style>
</head>

<body class="p-0 m-0">

    <div class="min-h-screen bg-[#F8FAFC] pb-24 max-w-md mx-auto shadow-2xl relative overflow-hidden">

        <!-- 1. 头部：战场仪表盘 (渐变优化) -->
        <div class="bg-gradient-to-br from-[#4F6BE4] via-[#6378D1] to-[#8093E8] text-white p-5 pt-8 rounded-b-[2.5rem] shadow-xl relative z-10 overflow-hidden">
            <!-- 背景装饰纹理 -->
            <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 40" fill="none" stroke="white" stroke-width="1"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" />
                </svg>
            </div>
            
            <div class="relative z-10">
                <div class="flex justify-between items-center mb-8">
                    <!-- 学科筛选 (横向平铺) -->
                    <div class="flex items-center gap-6" id="subject-tabs-container">
                        <!-- 由 SubjectSwitcher 组件动态生成 -->
                    </div>

                    <!-- 胶囊菜单 -->
                    <div class="capsule-btn">
                        <div class="flex gap-1">
                            <div class="w-1.5 h-1.5 bg-white rounded-full opacity-40"></div>
                            <div class="w-1.5 h-1.5 bg-white rounded-full"></div>
                            <div class="w-1.5 h-1.5 bg-white rounded-full opacity-40"></div>
                        </div>
                        <div class="w-[1px] h-3 bg-white/20"></div>
                        <div class="w-3.5 h-3.5 border-2 border-white rounded-full flex items-center justify-center">
                            <div class="w-1 h-1 bg-white rounded-full"></div>
                        </div>
                    </div>
                </div>

                <!-- 数据概览 -->
                <div class="flex justify-between items-end mb-6 px-1">
                    <div class="relative">
                        <div class="text-white/80 text-xs mb-1 font-medium tracking-wide">当前待消灭</div>
                        <div class="flex items-baseline gap-1">
                            <span class="text-5xl font-black stat-number text-white drop-shadow-sm">57</span>
                            <span class="text-xs font-medium text-white/70">题</span>
                        </div>
                    </div>
                    <div class="text-right pb-1">
                        <div class="text-white/80 text-xs mb-1 font-medium tracking-wide">本周已攻克</div>
                        <div class="flex items-center justify-end gap-1.5">
                            <div class="bg-white/20 p-1.5 rounded-lg backdrop-blur-md">
                                <i data-lucide="zap" class="w-4 h-4 fill-yellow-300 text-yellow-300"></i>
                            </div>
                            <span class="text-3xl font-black stat-number">12</span>
                            <span class="text-xs font-normal text-white/70">题</span>
                        </div>
                    </div>
                </div>

                <!-- 进度条 (细长呼吸条) -->
                <div class="px-1 mb-2">
                    <div class="breathing-bar">
                        <div class="breathing-bar-inner bg-[#FFB547]" style="width: 40%"></div>
                        <div class="breathing-bar-inner bg-[#A5F03D]" style="width: 60%"></div>
                    </div>
                </div>
                <div class="flex justify-between text-[10px] text-white/80 font-bold px-1 mb-6 tracking-tight">
                    <div class="flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-[#FFB547]"></span>
                        待攻克 40%
                    </div>
                    <div class="flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-[#A5F03D]"></span>
                        已掌握 60%
                    </div>
                </div>

                <!-- 2.1 Tab 切换 (集成到头部底部) -->
                <div id="tab-container" class="flex bg-black/10 backdrop-blur-md rounded-2xl p-1 border border-white/10">
                    <!-- Tabs injected via JS -->
                </div>
            </div>
        </div>

        <!-- 2. 列表区域容器 -->
        <div class="px-4 mt-6 relative z-20 min-h-[60vh] pb-24">
            <!-- 筛选栏 (简化视觉) -->
            <div class="filter-chip-row scrollbar-hide mb-6">
                <div class="filter-chip-item" onclick="toggleModal('filter-modal')">
                    时间 <i data-lucide="chevron-down" class="w-3.5 h-3.5 opacity-40"></i>
                </div>
                <div class="filter-chip-item" onclick="toggleModal('filter-modal')">
                    难度 <i data-lucide="chevron-down" class="w-3.5 h-3.5 opacity-40"></i>
                </div>
                <div class="filter-chip-item" onclick="toggleModal('filter-modal')">
                    更多 <i data-lucide="chevron-down" class="w-3.5 h-3.5 opacity-40"></i>
                </div>
                <div class="ml-auto flex items-center gap-2">
                    <button class="w-9 h-9 bg-white border border-gray-200 rounded-full flex items-center justify-center shadow-sm active:scale-90 transition-transform" onclick="toggleModal('download-modal')">
                        <i data-lucide="download" class="w-4 h-4 text-gray-600"></i>
                    </button>
                </div>
            </div>

            <!-- 3. 错题列表 -->
            <div id="mistake-list" class="space-y-5">
                <!-- Cards injected via JS -->
            </div>
        </div>

        <!-- 悬浮按钮 (FAB) -->
        <div class="fab-container">
            <button class="fab-main" onclick="collectWrong()">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
        </div>

        <!-- ================= 弹窗区域 ================= -->

        <!-- A. 筛选弹窗 (Filter Modal) -->
        <div id="filter-modal" class="fixed inset-0 z-[100] hidden">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity"
                onclick="toggleModal('filter-modal')"></div>
            <div
                class="absolute bottom-0 w-full bg-white rounded-t-3xl p-6 modal-enter max-w-md mx-auto left-0 right-0 h-[85vh] flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-black text-gray-800 tracking-tight">筛选错题</h3>
                    <button onclick="toggleModal('filter-modal')" class="w-8 h-8 bg-gray-50 rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 transition-colors">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>

                <div class="flex-1 overflow-y-auto scrollbar-hide space-y-8 pb-4">
                    <!-- 1. 错因记录 -->
                    <div class="space-y-4">
                        <label class="text-[13px] font-bold text-gray-800 flex items-center gap-2">
                            <span class="w-1 h-3 bg-[#4F6BE4] rounded-full"></span> 错因记录
                        </label>
                        <div class="flex flex-wrap gap-2.5">
                            <filter-chip label="审题不清"></filter-chip>
                            <filter-chip label="概念未掌握"></filter-chip>
                            <filter-chip label="运算错误"></filter-chip>
                            <filter-chip label="没有思路"></filter-chip>
                            <filter-chip label="马虎粗心"></filter-chip>
                        </div>
                    </div>

                    <!-- 2. 题型 -->
                    <div class="space-y-4">
                        <label class="text-[13px] font-bold text-gray-800 flex items-center gap-2">
                            <span class="w-1 h-3 bg-[#09C0D7] rounded-full"></span> 题型筛选
                        </label>
                        <div class="flex flex-wrap gap-2.5">
                            <filter-chip label="选择题" active></filter-chip>
                            <filter-chip label="填空题" active></filter-chip>
                            <filter-chip label="判断题"></filter-chip>
                            <filter-chip label="计算题" active></filter-chip>
                        </div>
                    </div>

                    <div class="h-px bg-gray-100 w-full"></div>
                    <div class="text-[10px] text-gray-400 font-bold tracking-widest uppercase">其他筛选</div>

                    <!-- 3. 年级筛选 (已在外表显示) -->
                    <div class="space-y-3 opacity-60">
                        <label class="text-sm font-bold text-gray-800 flex items-center gap-2">
                            <span class="w-1 h-4 bg-gray-300 rounded-full"></span> 年级
                        </label>
                        <div class="flex flex-wrap gap-2.5">
                            <filter-chip label="一年级"></filter-chip>
                            <filter-chip label="二年级"></filter-chip>
                            <filter-chip label="三年级"></filter-chip>
                            <filter-chip label="四年级"></filter-chip>
                            <filter-chip label="五年级" active></filter-chip>
                            <filter-chip label="六年级"></filter-chip>
                            <filter-chip label="七年级"></filter-chip>
                            <filter-chip label="八年级"></filter-chip>
                            <filter-chip label="九年级"></filter-chip>
                        </div>
                    </div>

                    <!-- 4. 难度等级 (已在外表显示) -->
                    <div class="space-y-3 opacity-60">
                        <label class="text-sm font-bold text-gray-800 flex items-center gap-2">
                            <span class="w-1 h-4 bg-gray-300 rounded-full"></span> 难度等级
                        </label>
                        <div class="flex flex-wrap gap-2.5">
                            <filter-chip label="1星 (基础)"></filter-chip>
                            <filter-chip label="2星 (简单)"></filter-chip>
                            <filter-chip label="3星 (中等)" active></filter-chip>
                            <filter-chip label="4星 (较难)"></filter-chip>
                            <filter-chip label="5星 (困难)"></filter-chip>
                        </div>
                    </div>

                    <!-- 5. 录入时间 (已在外表显示) -->
                    <div class="space-y-3 opacity-60">
                        <label class="text-sm font-bold text-gray-800 flex items-center gap-2">
                            <span class="w-1 h-4 bg-gray-300 rounded-full"></span> 录入时间
                        </label>
                        <div class="flex flex-wrap gap-2.5">
                            <filter-chip label="本周" active></filter-chip>
                            <filter-chip label="本月"></filter-chip>
                            <filter-chip label="近3个月"></filter-chip>
                            <filter-chip label="本学期"></filter-chip>
                            <filter-chip label="全部时间"></filter-chip>
                            <filter-chip label="自定义日期"></filter-chip>
                        </div>
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-100 mt-2 flex gap-3">
                    <button
                        class="flex-1 py-3.5 rounded-xl bg-gray-100 text-gray-600 font-bold text-sm hover:bg-gray-200 transition-colors">重置</button>
                    <button onclick="toggleModal('filter-modal')"
                        class="flex-[2] py-3.5 rounded-xl bg-[#09C0D7] text-white font-bold text-sm shadow-lg shadow-cyan-100 hover:bg-[#08acc0] transition-colors">确认筛选
                        (12)</button>
                </div>
            </div>
        </div>

        <!-- B. 下载打印弹窗 (Download Modal) -->
        <div id="download-modal" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity"
                onclick="toggleModal('download-modal')"></div>
            <div
                class="absolute bottom-0 w-full bg-white rounded-t-3xl p-6 modal-enter max-w-md mx-auto left-0 right-0">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">生成练习卷</h3>
                    <button onclick="toggleModal('download-modal')" class="text-gray-400 hover:text-gray-600"><i
                            data-lucide="x" class="icon-base"></i></button>
                </div>

                <div class="space-y-6">
                    <!-- 试题选择 -->
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-bold text-gray-700">选择试题</span>
                            <button class="text-xs text-[#09C0D7] font-bold">全选 (57)</button>
                        </div>
                        <div class="text-xs text-gray-500">已选中当前列表中的 <span class="font-bold text-gray-800">12</span> 道错题
                        </div>
                    </div>

                    <!-- 导出设置 -->
                    <div class="space-y-3">
                        <label class="text-sm font-bold text-gray-700">导出内容设置</label>

                        <label class="flex items-center justify-between p-3 border border-gray-100 rounded-lg">
                            <span class="text-sm text-gray-600">仅包含原错题</span>
                            <input type="checkbox" checked class="w-5 h-5 accent-[#09C0D7] rounded">
                        </label>

                        <label class="flex items-center justify-between p-3 border border-gray-100 rounded-lg">
                            <div class="flex flex-col">
                                <span class="text-sm text-gray-600">包含AI变式题</span>
                                <span class="text-[10px] text-gray-400">每道错题生成同类题</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-gray-500">x 1</span>
                                <input type="checkbox" class="w-5 h-5 accent-[#09C0D7] rounded">
                            </div>
                        </label>

                        <label class="flex items-center justify-between p-3 border border-gray-100 rounded-lg">
                            <span class="text-sm text-gray-600">包含解析与答案</span>
                            <input type="checkbox" class="w-5 h-5 accent-[#09C0D7] rounded">
                        </label>
                    </div>

                    <button onclick="toggleModal('download-modal'); window.parent.postMessage({
                                type: 'SWITCH_TAB',
                                index: 3
                            }, '*');"
                        class="w-full py-3.5 rounded-xl bg-[#09C0D7] text-white font-bold text-sm shadow-lg shadow-cyan-100 flex items-center justify-center gap-2">
                        <i data-lucide="file-down" class="icon-small"></i> 立即导出 PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- C. AI 答疑弹窗 (AI QA Modal) -->
        <div id="ai-qa-modal" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity"
                onclick="toggleModal('ai-qa-modal')"></div>
            <div
                class="absolute bottom-0 w-full bg-white rounded-t-3xl p-6 modal-enter max-w-md mx-auto left-0 right-0 h-[70vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <div class="bg-indigo-100 p-2 rounded-full">
                            <i data-lucide="bot" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">AI 答疑助手</h3>
                    </div>
                    <button onclick="toggleModal('ai-qa-modal')" class="text-gray-400 hover:text-gray-600"><i
                            data-lucide="x" class="icon-base"></i></button>
                </div>

                <div class="flex-1 overflow-y-auto scrollbar-hide space-y-4 bg-gray-50 rounded-xl p-4 mb-4">
                    <!-- Chat Content -->
                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="bot" class="w-4 h-4 text-indigo-600"></i>
                        </div>
                        <div
                            class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-gray-700 leading-relaxed">
                            你好！我是你的AI学习助手。关于这道题，你有什么想问的吗？我可以为你讲解知识点，或者举几个类似的例子。
                        </div>
                    </div>

                    <div class="flex gap-3 flex-row-reverse">
                        <div class="w-8 h-8 rounded-full bg-[#09C0D7] flex items-center justify-center flex-shrink-0">
                            <span class="text-white text-xs font-bold">我</span>
                        </div>
                        <div
                            class="bg-[#09C0D7] p-3 rounded-2xl rounded-tr-none shadow-sm text-sm text-white leading-relaxed">
                            这道题我不太明白为什么选B，能详细讲讲吗？
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="bot" class="w-4 h-4 text-indigo-600"></i>
                        </div>
                        <div
                            class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-gray-700 leading-relaxed">
                            <p class="mb-2">好的，让我们来看看这道题。</p>
                            <p class="mb-2">题目问的是"happy"（快乐）的同义词。</p>
                            <ul class="list-disc pl-4 space-y-1 text-gray-600">
                                <li><strong>A. Angry</strong> 意思是“生气的”</li>
                                <li><strong>B. Glad</strong> 意思是“高兴的”，与 happy 同义</li>
                                <li><strong>C. Sad</strong> 意思是“悲伤的”</li>
                                <li><strong>D. Tired</strong> 意思是“疲惫的”</li>
                            </ul>
                            <p class="mt-2">所以正确答案是 B。记住了吗？Glad = Happy！</p>
                        </div>
                    </div>
                </div>

                <div class="relative">
                    <input type="text" placeholder="输入你的问题..."
                        class="w-full py-3 pl-4 pr-12 rounded-xl border border-gray-200 focus:border-[#09C0D7] focus:ring-2 focus:ring-[#09C0D7]/20 outline-none transition-all">
                    <button
                        class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-[#09C0D7] text-white rounded-lg hover:bg-[#08acc0]">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- D. 错误原因选择弹窗 (Reason Modal) -->
        <div id="reason-modal" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleModal('reason-modal')"></div>
            <div class="absolute bottom-0 w-full bg-white rounded-t-3xl p-6 modal-enter max-w-md mx-auto left-0 right-0">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">选择错误原因</h3>
                    <button onclick="toggleModal('reason-modal')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="icon-base"></i></button>
                </div>
                <div class="grid grid-cols-4 gap-3 mb-8" id="reason-options-container">
                    <!-- Options injected via JS -->
                </div>
                <button onclick="saveReason()" class="w-full py-3.5 rounded-xl bg-[#09C0D7] text-white font-bold text-sm shadow-lg shadow-cyan-100 hover:bg-[#08acc0] transition-colors">保存修改</button>
            </div>
        </div>

    </div>

    <script>
        // --- Gemini API (Keep Mock for demo) ---
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- 数据: 增加更多字段 ---
        const MOCK_MISTAKES = [
            {
                id: 1,
                subject: '语文',
                type: '判断题',
                difficulty: 4,
                status: 'new',
                content: '我知道本文（《大青树下的小学》）第3自然段写的是同学们课上认真读书和课下尽情玩耍的场景。',
                userAnswer: '√',
                correctAnswer: '×',
                reason: '概念未掌握', // 错因
                errorRate: '85%',     // 出错率
                analysis: '第3自然段主要描写了下课后的场景，课上的描写在第2自然段。此处是考察对课文段落主旨的理解。',
                videoTitle: '关联微课：段落场景分析'
            },
            {
                id: 2,
                subject: '数学',
                type: '计算题',
                difficulty: 5,
                status: 'new',
                content: '计算 $ \\frac{1}{2} + \\frac{1}{3} + \\frac{1}{6} $ 的结果，并写出主要步骤。',
                userAnswer: '1',
                correctAnswer: '1',
                reason: '步骤遗漏',
                errorRate: '60%',
                analysis: '虽然结果正确，但未写出通分的步骤。正确的步骤应是 $\\frac{3}{6} + \\frac{2}{6} + \\frac{1}{6} = \\frac{6}{6} = 1$。',
                videoTitle: '关联微课：分数加法与通分'
            },
            {
                id: 3,
                subject: '英语',
                type: '选择题',
                difficulty: 3,
                status: 'mastered',
                content: 'Which word means "happy"? A. Angry B. Glad C. Sad D. Tired',
                userAnswer: 'A',
                correctAnswer: 'B',
                reason: '马虎粗心',
                errorRate: '25%',
                analysis: 'Glad (adj.) 意为高兴的，快乐的。A. Angry (生气的)；C. Sad (悲伤的)；D. Tired (疲惫的)。',
                videoTitle: '关联微课：常用情绪形容词'
            },
            {
                id: 4,
                subject: '语文',
                type: '填空题',
                difficulty: 3,
                status: 'new',
                content: '看图填空：羊群 $\\to$ [      ] $\\to$ 白色的花',
                img: 'https://placehold.co/300x100/e0f2f1/00796b?text=Diagram+Placeholder',
                userAnswer: '草地',
                correctAnswer: '白色的大花',
                reason: '审题不清',
                errorRate: '40%',
                analysis: '根据课文比喻句“羊群一会儿上了小丘...像给无边的绿毯绣上了白色的大花”，本体是羊群，喻体是白色的大花。',
                videoTitle: '关联微课：比喻句解析'
            }
        ];

        let currentActiveTab = 'new';
        let currentSubjectFilter = '语文'; // 默认第一个学科

        // 状态颜色映射
        const statusMap = {
            new: { label: '待攻克', color: 'bg-orange-50 text-orange-600 border-orange-100' },
            mastered: { label: '已掌握', color: 'bg-green-50 text-green-600 border-green-100' }
        };

        // 错因颜色映射
        const reasonColorMap = {
            '概念未掌握': 'bg-purple-50 text-purple-600 border-purple-100',
            '步骤遗漏': 'bg-blue-50 text-blue-600 border-blue-100',
            '马虎粗心': 'bg-amber-50 text-amber-600 border-amber-100',
            '审题不清': 'bg-indigo-50 text-indigo-600 border-indigo-100',
            'default': 'bg-gray-50 text-gray-500 border-gray-100'
        };

        // --- 核心逻辑 ---

        function generateDifficultyStars(difficulty) {
            let starsHtml = '';
            for (let i = 0; i < 5; i++) {
                const colorClass = i < difficulty ? "text-orange-400 fill-orange-400" : "text-gray-200 fill-gray-100";
                starsHtml += `<i data-lucide="star" class="w-2.5 h-2.5 ${colorClass}"></i>`;
            }
            return starsHtml;
        }

        function generateMistakeCard(data) {
            const { id, subject, type, difficulty, status, content, img, userAnswer, correctAnswer, analysis, videoTitle, reason, errorRate } = data;
            const statusInfo = statusMap[status];
            const reasonClass = reasonColorMap[reason] || reasonColorMap['default'];

            return `
            <div id="card-${id}" onclick="window.location.href='jsx_wrong_detail.html?id=${id}'" class="bg-white rounded-[24px] shadow-sm border border-gray-100 overflow-hidden fade-in relative group transition-all duration-300 cursor-pointer hover:shadow-md hover:border-blue-100">
                <!-- 卡片头部: 信息聚合 -->
                <div class="px-5 py-4 flex justify-between items-center bg-white">
                    <div class="flex flex-col gap-1.5">
                        <div class="flex items-center gap-2">
                            <span class="text-[11px] font-bold text-gray-700">${subject} · ${type}</span>
                            <div class="flex gap-0.5 items-center ml-1">
                                ${generateDifficultyStars(difficulty)}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] text-gray-400 font-medium">${errorRate}学生也错</span>
                    </div>
                </div>

                <!-- 题目内容区 -->
                <div class="px-5 pb-5">
                    <!-- 错因标签 (置于题目上方) -->
                    <div class="mb-3 flex justify-between items-center">
                        <span class="text-[10px] px-2.5 py-1 rounded-full border ${reasonClass} font-bold tracking-wide">
                           # ${reason}
                        </span>
                        <!-- 编辑备注小笔头 -->
                        <button onclick="event.stopPropagation(); editMistakeNote('${id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-50 text-gray-400 hover:bg-blue-50 hover:text-blue-500 transition-all active:scale-90">
                            <i data-lucide="edit-3" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>

                    <div class="text-[14px] text-gray-800 font-medium leading-relaxed mb-4 pr-2">
                        ${content}
                    </div>
                    
                    ${img ? `<div class="mt-3 mb-4 rounded-xl overflow-hidden border border-gray-50 shadow-sm"><img src="${img}" class="w-full h-auto object-cover"></div>` : ''}

                    <!-- 遮挡答案区 (毛玻璃/沉降感设计) -->
                    <div class="mt-4 relative">
                        <div id="analysis-hidden-${id}">
                            <button onclick="toggleAnalysis('${id}')" class="w-full py-6 bg-gray-50/80 rounded-2xl text-gray-400 text-xs flex flex-col items-center justify-center gap-2 hover:bg-gray-100 transition-all active:scale-[.98] border border-gray-100">
                                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm mb-1">
                                    <i data-lucide="eye" class="w-5 h-5 text-[#09C0D7]"></i>
                                </div>
                                <span class="font-bold text-gray-500 tracking-wide">点击查看详细解析</span>
                            </button>
                        </div>

                        <div id="analysis-visible-${id}" class="hidden fade-in">
                            <div class="bg-blue-50/30 rounded-2xl p-4 border border-blue-100/50">
                                <div class="flex justify-between text-xs mb-3 pb-3 border-b border-blue-100/30">
                                    <span class="text-red-500 font-bold flex items-center gap-1.5">
                                        <i data-lucide="x-circle" class="w-3.5 h-3.5"></i>
                                        你的答案: ${userAnswer}
                                    </span>
                                    <span class="text-green-600 font-bold flex items-center gap-1.5">
                                        <i data-lucide="check-circle" class="w-3.5 h-3.5"></i>
                                        正确答案: ${correctAnswer}
                                    </span>
                                </div>
                                <div class="text-[13px] text-gray-600 leading-relaxed mb-4">
                                    <span class="font-bold text-[#09C0D7] mr-1">【解析】</span>${analysis}
                                </div>
                                <div class="flex items-center gap-3 bg-white p-3 rounded-xl border border-blue-100/50 cursor-pointer hover:border-blue-300 transition-colors">
                                    <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center">
                                        <i data-lucide="play" class="w-5 h-5 text-blue-500 fill-blue-500"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-xs font-bold text-gray-800 mb-0.5">${videoTitle}</div>
                                        <div class="text-[10px] text-gray-400 flex items-center gap-2">
                                            <span>03:45</span>
                                            <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                                            <span>320人学习</span>
                                        </div>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>
                                </div>
                            </div>
                            
                            <div class="mt-3 flex justify-end">
                                <button onclick="toggleAnalysis('${id}', false)" class="px-4 py-1.5 text-[11px] font-bold text-gray-400 hover:text-gray-600 flex items-center gap-1">
                                    收起解析 <i data-lucide="chevron-up" class="w-3.5 h-3.5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 底部操作栏: 视觉差异化 -->
                <div class="grid grid-cols-3 p-3 gap-2 bg-gray-50/50 border-t border-gray-50">
                    <button onclick="event.stopPropagation(); openAIQA('${id}')" class="h-10 flex items-center justify-center gap-1.5 text-xs font-bold text-blue-600 bg-white border border-blue-100 rounded-xl hover:bg-blue-50 active:scale-95 transition-all shadow-sm">
                        <i data-lucide="sparkles" class="w-3.5 h-3.5"></i> AI 答疑
                    </button>
                    <button onclick="event.stopPropagation(); previewPaper()" class="h-10 flex items-center justify-center gap-1.5 text-xs font-bold text-white bg-gradient-to-r from-[#09C0D7] to-[#08B4CA] rounded-xl hover:opacity-90 active:scale-95 transition-all shadow-md shadow-cyan-100">
                        <i data-lucide="copy" class="w-3.5 h-3.5"></i> 举一反三
                    </button>
                    <button onclick="event.stopPropagation()" class="h-10 flex items-center justify-center gap-1.5 text-xs font-bold text-green-600 bg-white border border-green-100 rounded-xl hover:bg-green-50 active:scale-95 transition-all shadow-sm">
                        <i data-lucide="check" class="w-4 h-4"></i> 标记掌握
                    </button>
                </div>
            </div>
        `;
        }

        function toggleAnalysis(id, show = true) {
            event.stopPropagation();
            const hidden = document.getElementById(`analysis-hidden-${id}`);
            const visible = document.getElementById(`analysis-visible-${id}`);
            if (show) {
                hidden.classList.add('hidden');
                visible.classList.remove('hidden');
            } else {
                hidden.classList.remove('hidden');
                visible.classList.add('hidden');
            }
            lucide.createIcons();
        }

        function toggleSelection(id) {
            const card = document.getElementById(`card-${id}`);
            card.classList.toggle('card-selected');
        }

        function openAIQA(id) {
            toggleModal('ai-qa-modal');
        }

        // --- 错因编辑逻辑 ---
        let currentEditingId = null;
        let currentSelectedReason = '';
        const REASON_OPTIONS = ['审题不清', '概念未掌握', '运算错误', '没有思路', '马虎粗心', '公式记错', '书写不规范', '步骤遗漏'];

        function editMistakeNote(id) {
            currentEditingId = id;
            const mistake = MOCK_MISTAKES.find(m => m.id == id);
            if (mistake) {
                currentSelectedReason = mistake.reason || '其他';
                renderReasonOptions();
                toggleModal('reason-modal');
            }
        }

        function renderReasonOptions() {
            const container = document.getElementById('reason-options-container');
            container.innerHTML = '';
            
            REASON_OPTIONS.forEach(reason => {
                const isSelected = reason === currentSelectedReason;
                const btn = document.createElement('button');
                // 动态样式：选中时高亮，未选中时灰色
                let classes = 'py-2 rounded-lg border font-medium text-[12px] transition-colors ';
                if (isSelected) {
                    classes += 'border-[#09C0D7] text-[#09C0D7] bg-[#09C0D7]/10 font-bold shadow-sm';
                } else {
                    classes += 'border-gray-200 text-gray-600 hover:bg-gray-50';
                }
                btn.className = classes;
                btn.innerText = reason;
                // 防止点击冒泡关闭弹窗
                btn.onclick = (e) => {
                    e.stopPropagation();
                    selectReason(reason);
                };
                container.appendChild(btn);
            });
        }

        function selectReason(reason) {
            currentSelectedReason = reason;
            renderReasonOptions();
        }

        function saveReason() {
            if (currentEditingId !== null) {
                const mistakeIndex = MOCK_MISTAKES.findIndex(m => m.id == currentEditingId);
                if (mistakeIndex !== -1) {
                    MOCK_MISTAKES[mistakeIndex].reason = currentSelectedReason;
                    renderMistakeList(); // 重新渲染列表以更新标签
                    toggleModal('reason-modal');
                }
            }
        }

        // --- 学科切换 Logic ---
        function initPage() {
            lucide.createIcons();

            // 初始化基础组件：学科切换
            new SubjectSwitcher({
                containerId: 'subject-tabs-container',
                subjects: ['语文', '数学', '英语', '物理'],
                initialSubject: currentSubjectFilter,
                onChange: (subject) => {
                    currentSubjectFilter = subject;
                    renderMistakeList();
                }
            });

            renderTabs();
            renderMistakeList();
        }

        // --- Tab 渲染 (集成化美化版) ---
        function renderTabs() {
            const tabContainer = document.getElementById('tab-container');
            tabContainer.innerHTML = '';

            const tabs = [
                { id: 'new', label: '待攻克' },
                { id: 'mastered', label: '已掌握' }
            ];

            tabs.forEach(tab => {
                const isActive = tab.id === currentActiveTab;
                const btn = document.createElement('button');
                btn.className = `flex-1 py-2 text-xs font-bold rounded-xl transition-all duration-300 flex items-center justify-center gap-2 ${isActive
                    ? 'bg-white text-[#4F6BE4] shadow-sm scale-100'
                    : 'text-white/60 hover:text-white'
                    }`;
                
                const dot = isActive ? '<span class="w-2 h-2 bg-[#4F6BE4] rounded-full shadow-[0_0_8px_rgba(79,107,228,0.4)]"></span>' : '';
                 btn.innerHTML = `${dot}${tab.label}`;
                
                btn.onclick = () => {
                    currentActiveTab = tab.id;
                    renderTabs();
                    renderMistakeList();
                };
                tabContainer.appendChild(btn);
            });
        }

        // --- 筛选与渲染逻辑 ---
        // (applyFilters removed as we now use specific subject tabs logic)

        function renderMistakeList() {
            const listContainer = document.getElementById('mistake-list');
            listContainer.innerHTML = '';

            const filtered = MOCK_MISTAKES.filter(m => {
                // Tab Filter
                if (currentActiveTab === 'new' && m.status !== 'new') return false;
                if (currentActiveTab === 'mastered' && m.status !== 'mastered') return false;

                // Subject Filter (Strict)
                if (m.subject !== currentSubjectFilter) return false;

                return true;
            });

            if (filtered.length === 0) {
                listContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 animate-pulse-slow">
                    <div class="w-32 h-32 bg-gray-100 rounded-full flex items-center justify-center mb-6">
                        <i data-lucide="ghost" class="w-16 h-16 text-gray-300"></i>
                    </div>
                    <p class="text-sm font-bold text-gray-400 mb-2">此处空空如也</p>
                    <p class="text-xs text-gray-300 mb-8">还没有录入该学科的错题哦</p>
                    <button onclick="collectWrong()" class="px-6 py-2.5 bg-white border border-gray-200 rounded-full text-xs font-bold text-gray-500 shadow-sm active:scale-95 transition-all">
                        去收集错题
                    </button>
                </div>
            `;
            } else {
                filtered.forEach(item => {
                    listContainer.insertAdjacentHTML('beforeend', generateMistakeCard(item));
                });
            }
            lucide.createIcons();
        }

        // --- 弹窗逻辑 ---
        window.toggleModal = function (modalId) {
            const modal = document.getElementById(modalId);
            const isHidden = modal.classList.contains('hidden');
            
            if (isHidden) {
                modal.classList.remove('hidden');
                // 通知父页面弹窗已打开，提高 iframe 层级
                window.parent.postMessage({ type: 'SET_MODAL_ACTIVE', active: true }, '*');
            } else {
                modal.classList.add('hidden');
                // 通知父页面弹窗已关闭，恢复 iframe 层级
                window.parent.postMessage({ type: 'SET_MODAL_ACTIVE', active: false }, '*');
            }
        }

        // 举一反三
        function previewPaper() {
            // 跳转到举一反三页面
            window.location.href = 'jsx_paper_preview.html';
        }

        // 收集错题
        function collectWrong() {
            // 跳转到错题采集页
            window.location.href = 'jsx_collect_wrong.html';
        }

        // --- Filter Chip Component Helper ---
        class FilterChipElement extends HTMLElement {
            connectedCallback() {
                const label = this.getAttribute('label');
                const active = this.hasAttribute('active');
                this.innerHTML = `
                <button class="px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${active
                        ? 'bg-cyan-50 text-[#09C0D7] border-[#09C0D7]'
                        : 'bg-white text-gray-500 border-gray-200 hover:border-gray-300'
                    }">
                    ${label}
                </button>
            `;
                this.querySelector('button').onclick = (e) => {
                    // Simple toggle visual for demo
                    const btn = e.target.closest('button');
                    if (btn.classList.contains('bg-cyan-50')) {
                        btn.className = 'px-3 py-1.5 rounded-full text-xs font-bold border transition-colors bg-white text-gray-500 border-gray-200 hover:border-gray-300';
                    } else {
                        btn.className = 'px-3 py-1.5 rounded-full text-xs font-bold border transition-colors bg-cyan-50 text-[#09C0D7] border-[#09C0D7]';
                    }
                };
            }
        }
        customElements.define('filter-chip', FilterChipElement);

        // 初始化
        window.onload = initPage;
    </script>

</body>

</html>