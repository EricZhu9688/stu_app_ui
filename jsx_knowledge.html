<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>个性化知识图谱</title>

  <!-- Tailwind CSS -->
  <script src="js/tailwind.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              500: '#0ea5e9',
              600: '#0284c7',
              900: '#0c4a6e',
            },
            status: {
              good: '#10b981',
              average: '#3b82f6',
              poor: '#ef4444',
              none: '#9ca3af',
            }
          }
        }
      }
    }
  </script>

  <!-- Babel for in-browser JSX transformation -->
  <script src="js/babel.min.js"></script>

  <!-- Custom Styles -->
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #e2e8f0;
      border-radius: 2px;
    }
  </style>

  <!-- Import Map for External Libraries -->
  <!-- FIXED: Removed conflicting React 19 references and pinned dependencies to React 18.2.0 -->
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
    "d3": "https://esm.sh/d3@7.8.5",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>

<body class="bg-slate-50 text-slate-800 antialiased">
  <div id="root" class="h-full w-full"></div>

  <!-- Main Application Script -->
  <script type="text/babel" data-type="module" data-presets="react,typescript">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import {
      ChevronDown, ChevronRight, BookOpen, Layers, Menu, Share2,
      X, BrainCircuit, AlertCircle, CheckCircle2, ZoomIn, ZoomOut, Maximize,
      ChevronLeft, MoreHorizontal
    } from 'lucide-react';
    import * as d3 from 'd3';

    // --- CONSTANTS ---
    // Defined at top level to avoid ReferenceErrors
    const MasteryLevel = {
      Good: 'good',
      Average: 'average',
      Poor: 'poor',
      None: 'none'
    };

    // --- MOCK DATA SERVICE ---
    const MOCK_SUBJECT = {
      name: "数学",
      bookVersion: "(新课标) 数学人教版",
      grade: "七年级上册"
    };

    const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    const generateGraphData = (centerLabel) => {
      const nodes = [
        { id: 'root', label: centerLabel, level: MasteryLevel.Average, group: 1, masteryRate: 78, errorCount: 2 },
        { id: 'n1', label: '绝对值的定义', level: MasteryLevel.Poor, group: 2, masteryRate: 45, errorCount: 12 },
        { id: 'n2', label: '相反数的应用', level: MasteryLevel.Poor, group: 2, masteryRate: 52, errorCount: 8 },
        { id: 'n3', label: '数轴的三要素', level: MasteryLevel.Poor, group: 2, masteryRate: 30, errorCount: 15 },
        { id: 'n4', label: '有理数的分类', level: MasteryLevel.Average, group: 2, masteryRate: 65, errorCount: 5 },
        { id: 'n5', label: '化简多重符号', level: MasteryLevel.Poor, group: 2, masteryRate: 40, errorCount: 9 },
        { id: 'n6', label: '0的意义', level: MasteryLevel.Poor, group: 2, masteryRate: 55, errorCount: 4 },
        { id: 'n7', label: '带有字母的绝对值', level: MasteryLevel.Poor, group: 2, masteryRate: 25, errorCount: 20 },
        { id: 'n8', label: '用数轴上的点表示', level: MasteryLevel.Poor, group: 2, masteryRate: 48, errorCount: 7 },
        { id: 'n9', label: '根据点在数轴的位置', level: MasteryLevel.Poor, group: 2, masteryRate: 33, errorCount: 11 },
        { id: 'n10', label: '有理数大小比较', level: MasteryLevel.Poor, group: 2, masteryRate: 42, errorCount: 10 },
        { id: 'n11', label: '绝对值的几何意义', level: MasteryLevel.Poor, group: 2, masteryRate: 38, errorCount: 13 },
        { id: 'n12', label: '相反数的定义', level: MasteryLevel.Poor, group: 2, masteryRate: 60, errorCount: 3 },
        { id: 'n13', label: '绝对值非负性', level: MasteryLevel.Poor, group: 2, masteryRate: 20, errorCount: 18 },
        { id: 'n14', label: '带“非”字的理解', level: MasteryLevel.Poor, group: 2, masteryRate: 45, errorCount: 6 },
        { id: 'n15', label: '绝对值方程', level: MasteryLevel.Average, group: 2, masteryRate: 70, errorCount: 4 },
        { id: 'n16', label: '数轴上的动点问题', level: MasteryLevel.Poor, group: 3, masteryRate: 15, errorCount: 25 },
        { id: 'n17', label: '求一个数的绝对值', level: MasteryLevel.Poor, group: 3, masteryRate: 50, errorCount: 5 },
      ];

      const randomizedNodes = nodes.map(n => {
        const isGood = Math.random() > 0.7;
        return {
          ...n,
          level: isGood ? MasteryLevel.Good : n.level,
          masteryRate: isGood ? getRandomInt(80, 100) : n.masteryRate,
          errorCount: isGood ? getRandomInt(0, 3) : n.errorCount
        };
      });

      const links = [
        { source: 'root', target: 'n1', value: 1, type: 'hierarchy' },
        { source: 'root', target: 'n4', value: 1, type: 'hierarchy' },
        { source: 'root', target: 'n10', value: 1, type: 'hierarchy' },
        { source: 'n1', target: 'n11', value: 1, type: 'hierarchy' },
        { source: 'n1', target: 'n13', value: 1, type: 'hierarchy' },
        { source: 'n4', target: 'n14', value: 1, type: 'hierarchy' },
        { source: 'n10', target: 'n2', value: 1, type: 'hierarchy' },
        { source: 'n10', target: 'n3', value: 1, type: 'hierarchy' },
        { source: 'n10', target: 'n15', value: 1, type: 'hierarchy' },
        { source: 'n10', target: 'n5', value: 1, type: 'hierarchy' },
        { source: 'n5', target: 'n6', value: 1, type: 'hierarchy' },
        { source: 'n15', target: 'n7', value: 1, type: 'hierarchy' },
        { source: 'n15', target: 'n8', value: 1, type: 'hierarchy' },
        { source: 'n15', target: 'n9', value: 1, type: 'hierarchy' },
        { source: 'n2', target: 'n12', value: 1, type: 'hierarchy' },
        { source: 'n3', target: 'n16', value: 1, type: 'hierarchy' },
        { source: 'n3', target: 'n17', value: 1, type: 'hierarchy' },
        { source: 'n12', target: 'n2', value: 1, type: 'prerequisite' },
        { source: 'n1', target: 'n15', value: 1, type: 'prerequisite' },
        { source: 'n11', target: 'n16', value: 1, type: 'related' },
        { source: 'n6', target: 'n13', value: 1, type: 'related' },
      ];

      return { nodes: randomizedNodes, links };
    };

    const MOCK_CHAPTERS = [
      {
        id: 'c1',
        title: '第一章 有理数',
        sections: [
          { id: 's1.1', title: '1.1 正数和负数', graphData: generateGraphData('正数和负数') },
          { id: 's1.2', title: '1.2 有理数及其大小比较', graphData: generateGraphData('有理数大小比较') },
          { id: 's1.3', title: '1.3 有理数的加减法', graphData: generateGraphData('加减法法则') },
          { id: 's1.4', title: '1.4 有理数的乘除法', graphData: generateGraphData('乘除混合运算') },
          { id: 's1.5', title: '1.5 有理数的乘方', graphData: generateGraphData('科学计数法') },
        ]
      },
      {
        id: 'c2',
        title: '第二章 整式的加减',
        sections: [
          { id: 's2.1', title: '2.1 整式', graphData: generateGraphData('单项式与多项式') },
          { id: 's2.2', title: '2.2 整式的加减', graphData: generateGraphData('合并同类项') },
        ]
      },
      {
        id: 'c3',
        title: '第三章 一元一次方程',
        sections: [
          { id: 's3.1', title: '3.1 从算式到方程', graphData: generateGraphData('方程的概念') },
          { id: 's3.2', title: '3.2 解一元一次方程(一)', graphData: generateGraphData('移项与合并') },
        ]
      }
    ];

    // --- COMPONENT: KnowledgeGraph ---
    const KnowledgeGraph = ({ data, onNodeClick, selectedNodeId }) => {
      const containerRef = useRef(null);
      const svgRef = useRef(null);
      const [zoomLevel, setZoomLevel] = useState(1);

      const getColor = (level) => {
        switch (level) {
          case MasteryLevel.Good: return '#10b981';
          case MasteryLevel.Average: return '#3b82f6';
          case MasteryLevel.Poor: return '#ef4444';
          default: return '#9ca3af';
        }
      };

      const getRadius = (level, isRoot) => {
        if (isRoot) return 22;
        return 14;
      };

      useEffect(() => {
        if (!svgRef.current || !containerRef.current) return;

        const width = containerRef.current.clientWidth;
        const height = containerRef.current.clientHeight;

        const svg = d3.select(svgRef.current);
        svg.selectAll("*").remove();

        const defs = svg.append("defs");

        defs.append("marker")
          .attr("id", "arrow-prerequisite")
          .attr("viewBox", "0 -5 10 10")
          .attr("refX", 24)
          .attr("refY", 0)
          .attr("markerWidth", 8)
          .attr("markerHeight", 8)
          .attr("orient", "auto")
          .append("path")
          .attr("d", "M0,-5L10,0L0,5")
          .attr("fill", "#fbbf24");

        const g = svg.append("g");

        const zoom = d3.zoom()
          .scaleExtent([0.1, 4])
          .on("zoom", (event) => {
            g.attr("transform", event.transform);
            setZoomLevel(event.transform.k);
          });

        svg.call(zoom)
          .call(zoom.transform, d3.zoomIdentity.translate(width / 2, height / 2).scale(0.8));

        // Deep copy nodes to avoid D3 modifying React state directly if passed repeatedly
        const nodes = data.nodes.map(d => ({ ...d }));
        const links = data.links.map(d => ({ ...d }));

        const simulation = d3.forceSimulation(nodes)
          .force("link", d3.forceLink(links)
            .id(d => d.id)
            .distance(d => d.type === 'hierarchy' ? 80 : 120)
          )
          .force("charge", d3.forceManyBody().strength(-500))
          .force("center", d3.forceCenter(0, 0))
          .force("collide", d3.forceCollide().radius(40));

        const link = g.append("g")
          .selectAll("path")
          .data(links)
          .join("path")
          .attr("fill", "none")
          .attr("stroke-width", 1.5)
          .attr("stroke", d => {
            if (d.type === 'prerequisite') return '#fbbf24';
            if (d.type === 'related') return '#cbd5e1';
            return '#cbd5e1';
          })
          .attr("stroke-dasharray", d => {
            if (d.type === 'prerequisite') return '5,5';
            if (d.type === 'related') return '2,2';
            return 'none';
          })
          .attr("marker-end", d => d.type === 'prerequisite' ? "url(#arrow-prerequisite)" : null);

        const nodeGroup = g.append("g")
          .selectAll("g")
          .data(nodes)
          .join("g")
          .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended))
          .on("click", (event, d) => {
            event.stopPropagation();
            onNodeClick(d);
          });

        nodeGroup.append("circle")
          .attr("r", d => getRadius(d.level, d.id === 'root') + 6)
          .attr("fill", "none")
          .attr("stroke", "#3b82f6")
          .attr("stroke-width", 3)
          .attr("opacity", d => d.id === selectedNodeId ? 0.5 : 0);

        nodeGroup.append("circle")
          .attr("r", d => getRadius(d.level, d.id === 'root'))
          .attr("fill", d => getColor(d.level))
          .attr("stroke", "#fff")
          .attr("stroke-width", 2)
          .attr("cursor", "pointer")
          .style("filter", "drop-shadow(2px 2px 3px rgba(0,0,0,0.15))");

        const labelGroup = nodeGroup.append("g")
          .attr("transform", d => `translate(0, ${getRadius(d.level, d.id === 'root') + 16})`);

        labelGroup.append("rect")
          .attr("x", -50)
          .attr("y", -8)
          .attr("width", 100)
          .attr("height", 16)
          .attr("rx", 4)
          .attr("fill", "white")
          .attr("opacity", 0.6);

        labelGroup.append("text")
          .text(d => d.label)
          .attr("text-anchor", "middle")
          .attr("dy", "0.35em")
          .attr("font-size", "11px")
          .attr("fill", "#1e293b")
          .attr("font-weight", "600")
          .style("pointer-events", "none")
          .style("text-shadow", "0 1px 2px white");

        simulation.on("tick", () => {
          link.attr("d", d => `M${d.source.x},${d.source.y}L${d.target.x},${d.target.y}`);
          nodeGroup.attr("transform", d => `translate(${d.x},${d.y})`);
        });

        function dragstarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }

        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
        }

        function dragended(event, d) {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        }

        return () => {
          simulation.stop();
        };
      }, [data, selectedNodeId]);

      const handleZoom = (factor) => {
        if (!svgRef.current) return;
        const svg = d3.select(svgRef.current);
        const width = containerRef.current?.clientWidth || 0;
        const height = containerRef.current?.clientHeight || 0;
        svg.transition().duration(750).call(
          d3.zoom().transform,
          d3.zoomIdentity.translate(width / 2, height / 2).scale(factor).translate(-width / 2, -height / 2)
        );
      };

      return (
        <div ref={containerRef} className="w-full h-full relative bg-slate-50 overflow-hidden">
          <svg ref={svgRef} width="100%" height="100%" className="touch-action-none" onClick={() => onNodeClick(null)} />

          <div className="absolute top-4 right-4 bg-white/95 backdrop-blur-sm p-3 rounded-xl shadow-lg border border-slate-100 flex flex-col gap-3 z-10 min-w-[140px]">
            <div>
              <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">掌握程度</div>
              <div className="space-y-1.5">
                {[
                  { label: '掌握较好 (80-100%)', color: 'bg-status-good' },
                  { label: '掌握一般 (60-80%)', color: 'bg-status-average' },
                  { label: '掌握较差 (<60%)', color: 'bg-status-poor' },
                ].map((item) => (
                  <div key={item.label} className="flex items-center gap-2">
                    <span className={`w-2.5 h-2.5 rounded-full ${item.color} shadow-sm ring-1 ring-inset ring-black/5`}></span>
                    <span className="text-xs text-slate-600 font-medium">{item.label}</span>
                  </div>
                ))}
              </div>
            </div>
            <div className="border-t border-slate-100 pt-2">
              <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">关系类型</div>
              <div className="space-y-1.5">
                <div className="flex items-center gap-2">
                  <div className="w-6 h-0.5 bg-slate-300"></div>
                  <span className="text-xs text-slate-600">层级关系</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-6 h-0 border-t-2 border-dashed border-amber-400 relative">
                    <div className="absolute right-0 top-1/2 -translate-y-1/2 -mt-[3px] border-l-4 border-l-amber-400 border-y-4 border-y-transparent"></div>
                  </div>
                  <span className="text-xs text-slate-600">前置知识</span>
                </div>
                <div className="flex items-center gap-2">
                  <div className="w-6 h-0 border-t-2 border-dotted border-slate-400"></div>
                  <span className="text-xs text-slate-600">关联知识</span>
                </div>
              </div>
            </div>
          </div>

          <div className="absolute bottom-6 right-6 flex flex-col gap-2 z-10">
            <button onClick={() => handleZoom(zoomLevel * 1.2)} className="p-2.5 bg-white rounded-full shadow-lg text-slate-600 hover:text-brand-600 hover:bg-blue-50 transition-all active:scale-95 border border-slate-100"><ZoomIn size={20} /></button>
            <button onClick={() => handleZoom(1)} className="p-2.5 bg-white rounded-full shadow-lg text-slate-600 hover:text-brand-600 hover:bg-blue-50 transition-all active:scale-95 border border-slate-100"><Maximize size={20} /></button>
            <button onClick={() => handleZoom(zoomLevel * 0.8)} className="p-2.5 bg-white rounded-full shadow-lg text-slate-600 hover:text-brand-600 hover:bg-blue-50 transition-all active:scale-95 border border-slate-100"><ZoomOut size={20} /></button>
          </div>
        </div>
      );
    };

    // --- COMPONENT: Sidebar ---
    const Sidebar = ({ subject, chapters, currentSectionId, onSelectSection, mobileOpen, setMobileOpen }) => {
      const [expandedChapters, setExpandedChapters] = useState({ 'c1': true });

      const toggleChapter = (chapterId) => {
        setExpandedChapters(prev => ({ ...prev, [chapterId]: !prev[chapterId] }));
      };

      const handleSelect = (section, chapter) => {
        onSelectSection(section, chapter);
        if (window.innerWidth < 768) setMobileOpen(false);
      };

      return (
        <>
          <div
            className={`fixed inset-0 bg-black/50 z-20 transition-opacity duration-300 md:hidden ${mobileOpen ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}
            onClick={() => setMobileOpen(false)}
          />
          <div className={`
              fixed md:static inset-y-0 left-0 z-30 w-72 bg-white border-r border-slate-200 flex flex-col transform transition-transform duration-300 ease-in-out
              ${mobileOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}
            `}>
            <div className="p-6 pb-4 border-b border-slate-100">
              <div className="bg-gradient-to-br from-blue-50 to-white border border-blue-100 rounded-2xl p-5 shadow-sm relative overflow-hidden group">
                <div className="absolute top-0 right-0 w-16 h-16 bg-blue-100/50 rounded-full -mr-8 -mt-8 pointer-events-none"></div>
                <div className="flex justify-between items-start mb-2">
                  <h2 className="text-2xl font-bold text-slate-800 tracking-tight">{subject.name}</h2>
                  <BookOpen className="w-5 h-5 text-brand-500" />
                </div>
                <p className="text-sm text-slate-500 mt-2 font-medium">{subject.grade}</p>
                <p className="text-xs text-slate-400 mt-1 line-clamp-1">{subject.bookVersion}</p>
              </div>
            </div>
            <div className="px-6 py-4">
              <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                <span className="w-1 h-5 bg-brand-500 rounded-full"></span>
                目录
              </h3>
            </div>
            <div className="flex-1 overflow-y-auto px-4 pb-6 space-y-3 custom-scrollbar">
              {chapters.map((chapter) => {
                const isExpanded = expandedChapters[chapter.id];
                return (
                  <div key={chapter.id} className="bg-slate-50 rounded-xl overflow-hidden border border-slate-100 transition-shadow hover:shadow-md">
                    <button
                      onClick={() => toggleChapter(chapter.id)}
                      className="w-full flex items-center justify-between p-4 text-left bg-white hover:bg-slate-50 transition-colors"
                    >
                      <span className={`font-semibold text-sm ${isExpanded ? 'text-brand-600' : 'text-slate-700'}`}>
                        {chapter.title}
                      </span>
                      {isExpanded ? <ChevronDown className="w-4 h-4 text-slate-400" /> : <ChevronRight className="w-4 h-4 text-slate-400" />}
                    </button>
                    <div className={`bg-slate-50/50 overflow-hidden transition-all duration-300 ease-in-out ${isExpanded ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'}`}>
                      <div className="p-2 space-y-1">
                        {chapter.sections.map((section) => {
                          const isActive = section.id === currentSectionId;
                          return (
                            <button
                              key={section.id}
                              onClick={() => handleSelect(section, chapter)}
                              className={`
                                  w-full flex items-center justify-between px-4 py-3 rounded-lg text-sm transition-all duration-200
                                  ${isActive ? 'bg-white text-brand-600 shadow-sm border border-brand-100 ring-1 ring-brand-100/50' : 'text-slate-600 hover:bg-white hover:text-slate-900 hover:shadow-sm'}
                                `}
                            >
                              <span className="truncate mr-2">{section.title}</span>
                              {isActive && <ChevronRight className="w-3 h-3 text-brand-500 flex-shrink-0" />}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </>
      );
    };

    // --- COMPONENT: App ---
    const App = () => {
      const [currentChapter, setCurrentChapter] = useState(MOCK_CHAPTERS[0]);
      const [currentSection, setCurrentSection] = useState(MOCK_CHAPTERS[0].sections[1]);
      const [sidebarOpen, setSidebarOpen] = useState(false);
      const [selectedNode, setSelectedNode] = useState(null);
      const [aiLoading, setAiLoading] = useState(false);
      const [aiContent, setAiContent] = useState(null);

      const handleSectionSelect = (section, chapter) => {
        setCurrentSection(section);
        setCurrentChapter(chapter);
        setSelectedNode(null);
        setAiContent(null);
      };

      const handleNodeClick = (node) => {
        setSelectedNode(node);
        setAiContent(null);
        if (node && !node.id.includes('root')) {
          simulateAIGeneration(node.label);
        }
      };

      const simulateAIGeneration = (topic) => {
        setAiLoading(true);
        setTimeout(() => {
          setAiLoading(false);
          setAiContent({
            summary: `【AI 学习要点】${topic}是初中数学的核心概念之一。理解该概念关键在于掌握其几何意义与代数定义的互化。重点考察形式包括化简求值与数形结合应用。建议加强对特殊值（如0, 1, -1）的验证练习。`,
            question: `【AI 推荐练习】已知 a, b 为有理数，且 |a| = 3, |b| = 2，若 ab < 0，求 a + b 的值。`
          });
        }, 1500);
      };

      const getMasteryColor = (level) => {
        switch (level) {
          case MasteryLevel.Good: return 'text-emerald-500 bg-emerald-50 border-emerald-200';
          case MasteryLevel.Average: return 'text-blue-500 bg-blue-50 border-blue-200';
          case MasteryLevel.Poor: return 'text-red-500 bg-red-50 border-red-200';
          default: return 'text-slate-500 bg-slate-50 border-slate-200';
        }
      };

      return (
        <div className="flex h-screen w-full bg-slate-50 font-sans overflow-hidden">
          <Sidebar
            subject={MOCK_SUBJECT}
            chapters={MOCK_CHAPTERS}
            currentSectionId={currentSection.id}
            onSelectSection={handleSectionSelect}
            mobileOpen={sidebarOpen}
            setMobileOpen={setSidebarOpen}
          />
          <div className="flex-1 flex flex-col h-full relative">
            <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 md:px-6 shadow-sm z-20 flex-shrink-0">
              <div className="flex items-center gap-3">
                <button onClick={() => setSidebarOpen(true)} className="p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-lg md:hidden">
                  <Menu size={24} />
                </button>
                <h1 className="text-lg md:text-xl font-bold text-slate-800 tracking-tight flex items-center gap-2">个性化知识图谱</h1>
              </div>
              <div className="flex items-center gap-2">
                <button className="hidden md:block px-3 py-1.5 bg-brand-50 text-brand-600 rounded-full text-sm font-medium hover:bg-brand-100 transition-colors">生成学习报告</button>
                <button className="p-2 text-slate-400 hover:text-brand-600 hover:bg-slate-50 rounded-full transition-colors"><Share2 size={20} /></button>
              </div>
            </header>
            <main className="flex-1 relative flex overflow-hidden">
              <div className="absolute top-4 left-4 z-10 pointer-events-none">
                <div className="bg-white/90 backdrop-blur border border-slate-200 shadow-sm rounded-xl px-4 py-3 pointer-events-auto max-w-[80vw]">
                  <div className="flex items-center gap-2 text-xs font-bold text-brand-600 uppercase tracking-wider mb-0.5">
                    <span className="w-2 h-2 rounded-full bg-brand-500 animate-pulse"></span>
                    正在查看章节
                  </div>
                  <h2 className="text-sm md:text-base font-bold text-slate-800">{currentChapter.title} · {currentSection.title}</h2>
                </div>
              </div>
              <div className="flex-1 h-full bg-slate-50 relative">
                <KnowledgeGraph data={currentSection.graphData} onNodeClick={handleNodeClick} selectedNodeId={selectedNode?.id} />
              </div>
              <div className={`fixed inset-y-0 right-0 w-full md:w-96 bg-white shadow-2xl z-30 transform transition-transform duration-300 ease-in-out flex flex-col md:border-l md:border-slate-200 ${selectedNode ? 'translate-x-0' : 'translate-x-full'}`}>
                {selectedNode && (
                  <>
                    <div className="p-5 border-b border-slate-100 flex items-start justify-between bg-slate-50/50">
                      <div>
                        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border mb-2 ${getMasteryColor(selectedNode.level)}`}>
                          {selectedNode.level === MasteryLevel.Good ? '掌握良好' : selectedNode.level === MasteryLevel.Average ? '掌握一般' : '需重点关注'}
                        </span>
                        <h2 className="text-2xl font-bold text-slate-800">{selectedNode.label}</h2>
                      </div>
                      <button onClick={() => setSelectedNode(null)} className="p-2 -mr-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors"><X size={20} /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-5 space-y-6">
                      <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white border border-slate-100 rounded-xl p-4 shadow-sm flex flex-col items-center justify-center text-center">
                          <div className="text-3xl font-black text-brand-600 mb-1">{selectedNode.masteryRate}<span className="text-sm text-slate-400 font-normal ml-1">%</span></div>
                          <div className="text-xs text-slate-500 font-medium">知识点掌握率</div>
                        </div>
                        <div className="bg-white border border-slate-100 rounded-xl p-4 shadow-sm flex flex-col items-center justify-center text-center group cursor-pointer hover:border-red-200 hover:bg-red-50/30 transition-colors">
                          <div className="text-3xl font-black text-red-500 mb-1">{selectedNode.errorCount}</div>
                          <div className="text-xs text-slate-500 font-medium group-hover:text-red-600 flex items-center gap-1">历史错题 <AlertCircle size={10} /></div>
                        </div>
                      </div>
                      <div className="space-y-4">
                        <div className="flex items-center gap-2 text-sm font-bold text-slate-800"><BrainCircuit className="w-4 h-4 text-violet-500" />AI 智能辅导</div>
                        {aiLoading ? (
                          <div className="bg-slate-50 rounded-xl p-4 border border-slate-100 space-y-3">
                            <div className="h-4 bg-slate-200 rounded w-3/4 animate-pulse"></div>
                            <div className="h-4 bg-slate-200 rounded w-full animate-pulse"></div>
                            <div className="h-4 bg-slate-200 rounded w-5/6 animate-pulse"></div>
                          </div>
                        ) : aiContent ? (
                          <div className="space-y-4 fade-in">
                            <div className="bg-gradient-to-br from-violet-50 to-white border border-violet-100 rounded-xl p-4 shadow-sm relative overflow-hidden">
                              <div className="absolute top-0 right-0 w-16 h-16 bg-violet-100/50 rounded-full -mr-8 -mt-8"></div>
                              <p className="text-sm text-slate-700 leading-relaxed relative z-10">{aiContent.summary}</p>
                            </div>
                            <div className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                              <div className="flex items-center gap-2 mb-2">
                                <div className="w-6 h-6 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center"><BookOpen size={14} /></div>
                                <span className="text-xs font-bold text-slate-500 uppercase">推荐练习</span>
                              </div>
                              <p className="text-sm text-slate-800 font-medium mb-3">{aiContent.question}</p>
                              <button className="w-full py-2 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium rounded-lg transition-colors flex items-center justify-center gap-2">开始练习</button>
                            </div>
                          </div>
                        ) : (
                          <div className="text-center py-8 text-slate-400 text-sm">点击生成获取分析</div>
                        )}
                      </div>
                      <div className="grid grid-cols-1 gap-3 pt-2">
                        <button className="w-full py-2.5 bg-white border border-slate-200 text-slate-700 font-medium rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-colors flex items-center justify-center gap-2"><AlertCircle size={16} className="text-red-500" />查看 {selectedNode.errorCount} 道错题解析</button>
                        <button className="w-full py-2.5 bg-white border border-slate-200 text-slate-700 font-medium rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-colors flex items-center justify-center gap-2"><CheckCircle2 size={16} className="text-green-500" />标记为已掌握</button>
                      </div>
                    </div>
                  </>
                )}
              </div>
              {selectedNode && <div className="fixed inset-0 bg-black/20 backdrop-blur-[1px] z-20 md:hidden" onClick={() => setSelectedNode(null)} />}
            </main>
          </div>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>