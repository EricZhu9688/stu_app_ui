<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºç¡€æ€§ä½œä¸šä¸“æ </title>
    <script src="js/tailwind.min.js"></script>
    <script src="js/lucide.js"></script>
    <link rel="stylesheet" href="js/components/SubjectSwitcher.css">
    <script src="js/components/SubjectSwitcher.js"></script>
    <style>
        /* 1. è‡ªå®šä¹‰ä¸»é¢˜è‰²ï¼šè“è‰²ç³» (Blue/Indigo) */
        :root {
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-300: #93c5fd;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --header-bg: #5a67d8; /* æ¥è¿‘è®¾è®¡å›¾çš„æ·±è“ç´«è‰² */
            --header-bg-gradient: linear-gradient(135deg, #5a67d8 0%, #4c51bf 100%);
            --accent-green: #a3e635; /* è¿›åº¦æ¡äº®ç»¿è‰² */
            --accent-orange: #fb923c; /* é”™é¢˜æ•°å­—æ©™è‰² */
        }

        /* è¦†ç›– Tailwind é¢œè‰²ï¼Œä½¿ç”¨è‡ªå®šä¹‰å±æ€§ */
        .bg-primary-500 { background-color: var(--primary-500); }
        .text-primary-500 { color: var(--primary-500); }
        .text-primary-600 { color: var(--primary-600); }
        .bg-primary-50 { background-color: var(--primary-50); }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* æµ…ç°è‰²èƒŒæ™¯ */
        }

        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-enter { animation: slideInUp 0.3s ease-out forwards; }
        @keyframes slideInUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        /* é¡¶éƒ¨ Header æ ·å¼ */
        .custom-header {
            background: var(--header-bg);
            /* background: var(--header-bg-gradient); Optional gradient */
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.2);
            color: white;
        }

        /* éšè—æ»šåŠ¨æ¡ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* æ–‡æœ¬æº¢å‡ºå¤„ç† */
        .lesson-title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 140px;
        }
        @media (min-width: 375px) {
            .lesson-title { max-width: 180px; }
        }

        /* é’ˆå¯¹ SubjectSwitcher çš„æ ·å¼è¦†ç›– (å‡è®¾) */
        #subject-switcher .active {
            font-size: 1.125rem; /* text-lg */
            font-weight: 800;
            color: white !important;
            border-bottom: 2px solid white;
        }
        #subject-switcher button {
            color: rgba(255, 255, 255, 0.7);
            transition: color 0.2s;
        }
        #subject-switcher button:hover {
            color: white;
        }
    </style>
</head>

<body class="pb-20">

    <!-- 1. é¡¶éƒ¨åŒºåŸŸ (New Header Design) -->
    <div class="custom-header sticky top-0 z-20 pb-6 pt-2">
        <div class="px-4">
            <!-- é¡¶éƒ¨å­¦ç§‘åˆ‡æ¢ -->
            <div class="overflow-x-auto scrollbar-hide mb-4">
                <div class="flex gap-6 min-w-max px-2 items-end h-10" id="subject-switcher">
                    <!-- ç”± SubjectSwitcher ç»„ä»¶åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ ‡é¢˜ä¸ç‰ˆæœ¬æ ‡ç­¾ -->
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h1 class="text-lg font-bold leading-tight mb-2" id="current-subject-title">åŸºç¡€æ€§ä½œä¸šè¯­æ–‡å››å¹´çº§ä¸Šå†Œ</h1>
                    <div class="flex gap-2">
                        <span id="current-version" class="bg-white/20 backdrop-blur-sm px-2 py-0.5 rounded text-[10px] font-medium text-white/90">äººæ•™ç‰ˆ</span>
                        <span id="current-grade" class="bg-white/20 backdrop-blur-sm px-2 py-0.5 rounded text-[10px] font-medium text-white/90">ä¹å¹´çº§ä¸‹</span>
                    </div>
                </div>
                <!-- åˆ‡æ¢æ•™ææŒ‰é’® (Icon style) -->
                <button onclick="toggleTextbookModal()" class="bg-white/20 hover:bg-white/30 p-2 rounded-full text-white backdrop-blur-sm transition-colors mt-1">
                    <i data-lucide="arrow-left-right" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="text-[10px] opacity-80 mb-3">ï¼ˆå…± <span id="header-total-lessons">52</span> è¯¾æ—¶ï¼‰</div>

            <!-- è¿›åº¦æ¡ -->
            <div class="relative w-full bg-black/20 rounded-full h-1.5 mb-2">
                <div id="progress-bar" class="absolute left-0 top-0 h-1.5 rounded-full bg-[#a3e635] transition-all duration-500" style="width: 23%;"></div>
            </div>
            <div class="flex justify-end text-xs text-white/80 font-medium mb-5">
                å·²å®Œæˆ <span id="progress-done">12</span>/<span id="progress-total">52</span>
            </div>

            <!-- åº•éƒ¨ç»Ÿè®¡ä¸æŒ‰é’® -->
            <div class="flex items-center justify-between">
                <div class="flex items-baseline gap-1">
                    <span class="text-sm text-white/90">ç´¯è®¡é”™é¢˜</span>
                    <span class="text-3xl font-bold text-[#fdba74]" id="total-mistakes">48</span>
                    <span class="text-xs text-white/80">é¢˜</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="alert('ğŸ“– æ­£åœ¨è·³è½¬åˆ°ç­”æ¡ˆé¡µé¢...')" class="bg-white/20 hover:bg-white/30 text-white text-xs font-medium px-3 py-2 rounded-lg backdrop-blur-sm flex items-center gap-1.5 transition-colors">
                        <i data-lucide="file-text" class="w-4 h-4"></i> æŸ¥çœ‹ç­”æ¡ˆ
                    </button>
                    <button onclick="toggleAnalyticsModal()" class="bg-white/20 hover:bg-white/30 text-white text-xs font-medium px-3 py-2 rounded-lg backdrop-blur-sm flex items-center gap-1.5 transition-colors">
                        <i data-lucide="bar-chart-2" class="w-4 h-4"></i> ä¸“æ æ€»è§ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. å†…å®¹åˆ—è¡¨åŒºåŸŸ (New List Design) -->
    <div class="px-4 -mt-4 relative z-10 space-y-4 pb-10 pt-4" id="content-directory">
        <!-- Chapters rendered here -->
        <div id="lessons-container" class="space-y-4">
            <!-- å®¹å™¨ç”± JS å¡«å…… -->
        </div>
    </div>

    <!-- ==================== Modals (Keep existing structure) ==================== -->

    <!-- 4. å¢å¼ºç»ƒä¹ é€‰æ‹©å¼¹çª— -->
    <div id="enhanced-practice-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 transition-opacity" onclick="toggleEnhancedPracticeModal()"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl p-6 pb-24 modal-enter max-w-md mx-auto left-0 right-0">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="enhanced-modal-title">é€‰æ‹©å¢å¼ºç»ƒä¹ å·</h3>
                <button onclick="toggleEnhancedPracticeModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <p class="text-sm text-gray-500 mb-4 flex items-center gap-1">
                <i data-lucide="graduation-cap" class="w-4 h-4 text-orange-500"></i>
                ä¸“å®¶æ¨èï¼å»ºè®®æ ¹æ®è‡ªèº«å­¦ä¹ æƒ…å†µé€‰æ‹©åˆé€‚çš„ç»ƒä¹ å·ã€‚
            </p>
            <div id="enhanced-sets-list" class="space-y-3"></div>
        </div>
    </div>

    <!-- 5. æ•™æåˆ‡æ¢å¼¹çª— (ç­›é€‰æ•™è¾…) -->
    <div id="textbook-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 transition-opacity" onclick="toggleTextbookModal()"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl p-6 pb-24 modal-enter max-w-md mx-auto left-0 right-0">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">ç­›é€‰æ•™è¾…</h3>
                <button onclick="toggleTextbookModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="space-y-6 mb-8">
                <!-- ç‰ˆæœ¬é€‰æ‹© -->
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-1 h-4 bg-[#06b6d4] rounded-full"></div>
                        <h4 class="font-bold text-gray-800">ç‰ˆæœ¬</h4>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="selectTextbook(this, 'äººæ•™ç‰ˆ')" class="px-6 py-2 rounded-lg border border-[#06b6d4] text-[#06b6d4] font-bold bg-white shadow-sm shadow-cyan-100">äººæ•™ç‰ˆ</button>
                        <button onclick="selectTextbook(this, 'è‹æ•™ç‰ˆ')" class="px-6 py-2 rounded-lg border border-gray-200 text-gray-600 font-medium hover:bg-gray-50">è‹æ•™ç‰ˆ</button>
                    </div>
                </div>

                <!-- å¹´çº§å†Œåˆ«é€‰æ‹© (å°é¢æ¨¡å¼) -->
                <div>
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-1 h-4 bg-[#06b6d4] rounded-full"></div>
                        <h4 class="font-bold text-gray-800">å¹´çº§å†Œåˆ«</h4>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <!-- å°é¢é¡¹ï¼šé€‰ä¸­çŠ¶æ€ -->
                        <div class="flex flex-col items-center gap-2 group cursor-pointer" onclick="selectBookCover(this, 'å…­å¹´çº§ä¸Šå†Œ')">
                            <div class="relative w-full aspect-[3/4] rounded-lg border-2 border-[#06b6d4] p-1 shadow-md transition-transform active:scale-95">
                                <div class="w-full h-full bg-white rounded border border-gray-100 flex flex-col items-center justify-center p-2">
                                    <div class="text-[8px] text-gray-400 mb-1">ä¹‰åŠ¡æ•™è‚²æ•™ç§‘ä¹¦</div>
                                    <div class="w-full h-1/2 bg-red-400/10 rounded flex items-center justify-center mb-1">
                                        <span class="text-red-500 font-bold text-lg">æ•°å­¦</span>
                                    </div>
                                    <div class="text-[8px] text-gray-400 scale-75">äººæ•™ç‰ˆ</div>
                                </div>
                                <!-- å½“å‰é€‰ä¸­æ ‡ç­¾ -->
                                <div class="absolute -bottom-2.5 left-1/2 -translate-x-1/2 bg-[#06b6d4] text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm whitespace-nowrap z-10">
                                    å½“å‰é€‰ä¸­
                                </div>
                            </div>
                            <span class="text-sm font-medium text-gray-800 mt-1">å…­å¹´çº§ä¸Šå†Œ</span>
                        </div>

                         <!-- å°é¢é¡¹ï¼šæœªé€‰ä¸­ -->
                         <div class="flex flex-col items-center gap-2 group cursor-pointer" onclick="selectBookCover(this, 'å…­å¹´çº§ä¸‹å†Œ')">
                            <div class="relative w-full aspect-[3/4] rounded-lg border-2 border-transparent p-1 hover:bg-gray-50 transition-transform active:scale-95">
                                <div class="w-full h-full bg-white rounded border border-gray-200 flex flex-col items-center justify-center p-2 opacity-60 group-hover:opacity-100 transition-opacity">
                                    <div class="text-[8px] text-gray-400 mb-1">ä¹‰åŠ¡æ•™è‚²æ•™ç§‘ä¹¦</div>
                                    <div class="w-full h-1/2 bg-red-400/10 rounded flex items-center justify-center mb-1">
                                        <span class="text-red-500 font-bold text-lg">æ•°å­¦</span>
                                    </div>
                                    <div class="text-[8px] text-gray-400 scale-75">äººæ•™ç‰ˆ</div>
                                </div>
                            </div>
                            <span class="text-sm font-medium text-gray-500 group-hover:text-gray-700">å…­å¹´çº§ä¸‹å†Œ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨ç¡®å®šæŒ‰é’® -->
            <button onclick="toggleTextbookModal()" class="w-full bg-[#06b6d4] text-white text-lg font-bold py-3.5 rounded-xl shadow-lg shadow-cyan-200 active:scale-95 transition-transform">
                ç¡®å®š
            </button>
        </div>
    </div>

    <!-- 6. ä¸“æ æ€»è§ˆå¼¹çª— -->
    <div id="analytics-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 transition-opacity" onclick="toggleAnalyticsModal()"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl p-6 pb-24 modal-enter max-w-md mx-auto left-0 right-0">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">ä¸“æ å­¦æƒ…æ€»è§ˆ</h3>
                <button onclick="toggleAnalyticsModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-6">
                <div class="bg-gray-50 p-4 rounded-xl">
                    <div class="text-sm text-gray-500 mb-2">æ€»ä½“å®Œæˆè¿›åº¦</div>
                    <div class="flex items-end gap-2 mb-2">
                        <span class="text-3xl font-extrabold text-primary-600">23%</span>
                        <span class="text-sm text-gray-400 mb-1">å·²å®Œæˆ 12/52 è¯¾æ—¶</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-primary-500 h-2 rounded-full" style="width: 23%"></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                        <div class="text-xs text-red-400 mb-1">ç´¯è®¡é”™é¢˜</div>
                        <div class="text-2xl font-bold text-red-600">48 <span class="text-xs font-normal text-red-400">é¢˜</span></div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                        <div class="text-xs text-green-400 mb-1">å¾—åˆ†ç‡</div>
                        <div class="text-2xl font-bold text-green-600">85% <span class="text-xs font-normal text-green-400">å¹³å‡</span></div>
                    </div>
                </div>
                <div>
                    <div class="text-sm font-bold text-gray-800 mb-3">å¾…å¼ºåŒ–çŸ¥è¯†ç‚¹</div>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center p-3 bg-white border border-gray-100 rounded-lg shadow-sm">
                            <span class="text-sm text-gray-700">äºŒæ¬¡å‡½æ•°æœ€å€¼é—®é¢˜</span>
                            <span class="text-xs text-red-500 font-bold bg-red-50 px-2 py-1 rounded">æŒæ¡ç‡ 65%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. ä¸ªæ€§åŒ–ç»ƒä¹ ç”Ÿæˆå¼¹çª— -->
    <div id="personalized-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 transition-opacity" onclick="togglePersonalizedModal()"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-3xl p-6 pb-24 modal-enter max-w-md mx-auto left-0 right-0">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">ç”Ÿæˆä¸ªæ€§åŒ–ç»ƒä¹ </h3>
                <button onclick="togglePersonalizedModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-5">
                <div class="bg-primary-50 p-4 rounded-xl border border-primary-100">
                    <div class="text-xs text-primary-600 font-bold mb-1">é’ˆå¯¹è¯¾æ—¶</div>
                    <div class="text-sm font-bold text-gray-800 mb-2" id="personalized-target-title">ç¬¬ä¸€ç«  äºŒæ¬¡å‡½æ•°</div>
                    <div class="flex items-start gap-2 text-xs text-gray-600 bg-white/50 p-2 rounded-lg">
                        <i data-lucide="brain-circuit" class="w-4 h-4 text-primary-500 flex-shrink-0 mt-0.5"></i>
                        <span id="personalized-analysis">AIåˆ†æå‘ç°æ‚¨åœ¨â€œå‡½æ•°å›¾åƒæ€§è´¨â€å’Œâ€œæœ€å€¼æ±‚è§£â€æ–¹é¢å­˜åœ¨è–„å¼±ç‚¹ï¼Œå»ºè®®åŠ å¼ºç»ƒä¹ ã€‚</span>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="text-sm font-bold text-gray-700">éš¾åº¦åå¥½</div>
                    <div class="flex gap-2" id="difficulty-selector">
                        <button onclick="selectDifficulty(this, 'foundation')" class="flex-1 py-2 rounded-lg border border-gray-200 text-sm font-medium text-gray-600 hover:bg-gray-50">åŸºç¡€å·©å›º</button>
                        <button onclick="selectDifficulty(this, 'improvement')" class="flex-1 py-2 rounded-lg border-primary-500 bg-primary-50 text-sm font-bold text-primary-600 ring-1 ring-primary-500">èƒ½åŠ›æå‡</button>
                        <button onclick="selectDifficulty(this, 'challenge')" class="flex-1 py-2 rounded-lg border border-gray-200 text-sm font-medium text-gray-600 hover:bg-gray-50">æ‹“å±•æŒ‘æˆ˜</button>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="text-sm font-bold text-gray-700">é¢˜é‡è®¾ç½®</div>
                    <div class="flex gap-2" id="count-selector">
                        <button onclick="selectCount(this, 10)" class="flex-1 py-2 rounded-lg border-primary-500 bg-primary-50 text-sm font-bold text-primary-600 ring-1 ring-primary-500">10é¢˜ (æ¨è)</button>
                        <button onclick="selectCount(this, 15)" class="flex-1 py-2 rounded-lg border border-gray-200 text-sm font-medium text-gray-600 hover:bg-gray-50">15é¢˜</button>
                        <button onclick="selectCount(this, 20)" class="flex-1 py-2 rounded-lg border border-gray-200 text-sm font-medium text-gray-600 hover:bg-gray-50">20é¢˜</button>
                    </div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button onclick="generatePractice('download')" class="flex-1 py-3 bg-white border border-gray-200 text-gray-700 rounded-xl text-base font-bold active:scale-95 transition-transform hover:bg-gray-50">ç”Ÿæˆå¹¶ä¸‹è½½PDF</button>
                    <button onclick="generatePractice('online')" class="flex-1 py-3 bg-primary-500 text-white rounded-xl text-base font-bold shadow-lg shadow-primary-100 active:scale-95 transition-transform hover:bg-primary-600">å¼€å§‹åœ¨çº¿ç»ƒä¹ </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // åˆå§‹åŒ–åŸºç¡€ç»„ä»¶ï¼šå­¦ç§‘åˆ‡æ¢
        new SubjectSwitcher({
            containerId: 'subject-switcher',
            subjects: ['æ•°å­¦', 'è¯­æ–‡', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©'],
            initialSubject: 'æ•°å­¦',
            onChange: (subject) => {
                console.log('åˆ‡æ¢å­¦ç§‘:', subject);
                document.getElementById('current-subject-title').textContent = `åŸºç¡€æ€§ä½œä¸š${subject}ä¹å¹´çº§ä¸‹å†Œ`;
                renderProgress();
                renderLessons(false);
            }
        });

        // æ¨¡æ‹Ÿæ•°æ®ç»“æ„
        const mockLessons = [
            // Chapter 1
            { id: '1.1', title: '1. äºŒæ¬¡å‡½æ•°çš„æ¦‚å¿µ', pages: 'P1-P5', problems: 15, status: 'completed', mistakes: 5, assigned: true, chapter: 1, chapterTitle: 'ç¬¬ä¸€å•å…ƒ äºŒæ¬¡å‡½æ•°', allCorrect: false, allWrong: false },
            { id: '1.2', title: '2. äºŒæ¬¡å‡½æ•°çš„å›¾åƒå’Œæ€§è´¨', pages: 'P6-P10', problems: 20, status: 'pending', deadline: 'ä»Šæ—¥æˆªæ­¢', assigned: true, chapter: 1, chapterTitle: 'ç¬¬ä¸€å•å…ƒ äºŒæ¬¡å‡½æ•°', allCorrect: false, allWrong: false },
            { id: '1.3', title: '3. æŠ›ç‰©çº¿çš„å¹³ç§»', pages: 'P11-P15', problems: 18, status: 'completed', mistakes: 0, assigned: false, chapter: 1, chapterTitle: 'ç¬¬ä¸€å•å…ƒ äºŒæ¬¡å‡½æ•°', allCorrect: true, allWrong: false },
            { id: '1.4', title: '4. äºŒæ¬¡å‡½æ•°æœ€å€¼é—®é¢˜', pages: 'P16-P20', problems: 25, status: 'completed', mistakes: 25, assigned: false, chapter: 1, chapterTitle: 'ç¬¬ä¸€å•å…ƒ äºŒæ¬¡å‡½æ•°', allCorrect: false, allWrong: true },
            { id: '1.5', title: '5. ç›¸ä¼¼ä¸‰è§’å½¢åˆ¤å®š', pages: 'P21-P25', problems: 12, status: 'unassigned', mistakes: 0, assigned: false, chapter: 1, chapterTitle: 'ç¬¬ä¸€å•å…ƒ äºŒæ¬¡å‡½æ•°', allCorrect: false, allWrong: false },
            // Chapter 2
            { id: '2.1', title: '1. ç›¸ä¼¼å¤šè¾¹å½¢', pages: 'P26-P30', problems: 10, status: 'completed', mistakes: 2, assigned: true, chapter: 2, chapterTitle: 'ç¬¬äºŒå•å…ƒ ç›¸ä¼¼å›¾å½¢', allCorrect: false, allWrong: false },
            { id: '2.2', title: '2. ç›¸ä¼¼ä¸‰è§’å½¢çš„æ€§è´¨', pages: 'P31-P35', problems: 15, status: 'unassigned', mistakes: 0, assigned: false, chapter: 2, chapterTitle: 'ç¬¬äºŒå•å…ƒ ç›¸ä¼¼å›¾å½¢', allCorrect: false, allWrong: false },
            { id: '2.3', title: '3. ä½ä¼¼å›¾å½¢', pages: 'P36-P40', problems: 12, status: 'pending', deadline: 'æ˜æ—¥æˆªæ­¢', assigned: true, chapter: 2, chapterTitle: 'ç¬¬äºŒå•å…ƒ ç›¸ä¼¼å›¾å½¢', allCorrect: false, allWrong: false },
        ];

        function renderProgress() {
            const completedLessons = mockLessons.filter(l => l.status === 'completed').length;
            const totalLessons = mockLessons.length;
            const totalMistakes = mockLessons.reduce((sum, l) => sum + (l.mistakes || 0), 0);
            const progressPercentage = (completedLessons / totalLessons) * 100;

            document.getElementById('progress-done').textContent = completedLessons;
            document.getElementById('progress-total').textContent = totalLessons;
            document.getElementById('header-total-lessons').textContent = totalLessons;
            document.getElementById('total-mistakes').textContent = totalMistakes;
            document.getElementById('progress-bar').style.width = `${progressPercentage.toFixed(0)}%`;
        }

        // æ–°ç‰ˆæ¸²æŸ“å‡½æ•°
        function renderLessons(isFiltered) {
            const container = document.getElementById('lessons-container');
            container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
            
            // æŒ‰ç« èŠ‚åˆ†ç»„
            const chapters = {};
            mockLessons.forEach(lesson => {
                if (!chapters[lesson.chapter]) {
                    chapters[lesson.chapter] = {
                        title: lesson.chapterTitle || `ç¬¬ ${lesson.chapter} å•å…ƒ`,
                        lessons: []
                    };
                }
                chapters[lesson.chapter].lessons.push(lesson);
            });

            // éå†æ¸²æŸ“æ¯ä¸ªç« èŠ‚
            Object.values(chapters).forEach(chapterData => {
                const completedCount = chapterData.lessons.filter(l => l.status === 'completed').length;
                const totalCount = chapterData.lessons.length;
                
                let chapterHtml = `
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden mb-4">
                    <!-- Chapter Header -->
                    <div class="bg-gray-50/50 p-4 flex justify-between items-center border-b border-gray-100">
                         <div class="flex items-center gap-2 font-bold text-gray-800 text-sm">
                             <i data-lucide="book" class="w-5 h-5 text-[#5a67d8]"></i>
                             <span>${chapterData.title}</span>
                         </div>
                         <div class="flex items-center gap-3">
                             <button onclick="handleEnhancedPractice('${chapterData.title}', ['A å· (åŸºç¡€å·©å›º)', 'B å· (èƒ½åŠ›æå‡)', 'C å· (æ‹“å±•æŒ‘æˆ˜)'])"
                                class="text-xs bg-[#eff6ff] text-[#3b82f6] px-2.5 py-1.5 rounded-lg border border-[#bfdbfe] font-bold hover:bg-[#dbeafe] transition-colors flex items-center gap-1.5">
                                <i data-lucide="file-text" class="w-3.5 h-3.5"></i> å¢å¼ºç»ƒä¹ 
                             </button>
                             <span class="text-[10px] bg-gray-200 text-gray-600 px-2 py-1 rounded">${completedCount}/${totalCount} å®Œæˆ</span>
                         </div>
                    </div>

                    <!-- Lesson List -->
                    <div class="divide-y divide-gray-50">
                `;

                chapterData.lessons.forEach(lesson => {
                    // 1. Determine Status Styles & Tags
                    let starClass = 'text-gray-200 fill-gray-100'; // Default star
                    let tagHtml = '';
                    let actionHtml = '';

                    if (lesson.status === 'completed') {
                        starClass = 'text-[#5a67d8] fill-[#5a67d8]'; // Active star
                        
                        if (lesson.mistakes > 0) {
                            // æœ‰é”™é¢˜
                            tagHtml = `<span class="text-[10px] bg-red-50 text-red-500 px-1.5 py-0.5 rounded border border-red-100 font-medium">é”™${lesson.mistakes}é¢˜-å¾…å·©å›º</span>`;
                            actionHtml = `
                                <button class="text-xs text-gray-500 font-medium px-2" onclick="viewDetails('${lesson.id}', 'report')">å­¦æƒ…æŠ¥å‘Š</button>
                                <button class="text-xs bg-[#f43f5e] text-white px-3 py-1.5 rounded-full shadow-sm shadow-red-200 font-bold active:scale-95 transition-transform" onclick="togglePersonalizedModal('${lesson.title}')">ç²¾å‡†ç»ƒä¹ </button>
                            `;
                        } else {
                             // å…¨å¯¹
                            tagHtml = `<span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">å®Œç¾å®Œæˆ</span>`;
                            actionHtml = `
                                <button class="text-xs text-gray-500 font-medium px-2" onclick="viewDetails('${lesson.id}', 'report')">å­¦æƒ…æŠ¥å‘Š</button>
                                <button class="text-xs bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full font-bold active:scale-95 transition-transform" onclick="viewDetails('${lesson.id}', 'advanced')">è¿›é˜¶ç»ƒä¹ </button>
                            `;
                        }
                    } else {
                        // Pending or Unassigned
                        starClass = 'text-gray-200 fill-gray-100';
                        tagHtml = `<span class="text-[10px] bg-gray-100 text-gray-400 px-1.5 py-0.5 rounded">${lesson.pages} é¢˜é‡ ${lesson.problems}</span>`;
                        
                        let extraBtn = '';
                        // ç‰¹å®šé€»è¾‘ï¼š1.5 ç›¸ä¼¼ä¸‰è§’å½¢åˆ¤å®š æ·»åŠ æ‹ç…§æ‰¹æ”¹
                        if (lesson.id === '1.5') {
                            extraBtn = `<button class="text-xs text-gray-500 font-medium px-2 flex items-center gap-1 hover:text-gray-700 transition-colors" onclick="alert('ğŸ“¸ æ­£åœ¨å¯åŠ¨ç›¸æœºè¿›è¡Œæ™ºèƒ½æ‰¹æ”¹...')"><i data-lucide="camera" class="w-3.5 h-3.5"></i>æ‹ç…§æ‰¹æ”¹</button>`;
                        }

                        if (lesson.status === 'pending') {
                             actionHtml = `
                                ${extraBtn}
                                <span class="text-xs text-gray-300 mr-2">æ‰¹é˜…ä¸­...</span>
                                <button class="text-xs bg-[#06b6d4] text-white px-3 py-1.5 rounded-full shadow-sm shadow-cyan-200 font-bold active:scale-95 transition-transform" onclick="alert('æ ‡è®°é”™é¢˜')">æ ‡è®°é”™é¢˜</button>
                            `;
                        } else {
                             actionHtml = `
                                ${extraBtn}
                                <button class="text-xs bg-[#06b6d4] text-white px-3 py-1.5 rounded-full shadow-sm shadow-cyan-200 font-bold active:scale-95 transition-transform" onclick="alert('æ ‡è®°é”™é¢˜')">æ ‡è®°é”™é¢˜</button>
                            `;
                        }
                    }

                    chapterHtml += `
                        <div class="p-4 flex items-center gap-3 hover:bg-gray-50 transition-colors">
                            <!-- Star -->
                            <i data-lucide="star" class="w-5 h-5 ${starClass} flex-shrink-0"></i>
                            
                            <!-- Content -->
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-bold text-gray-800 mb-1 truncate">${lesson.title}</div>
                                <div class="flex items-center gap-2">
                                    ${tagHtml}
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="flex items-center gap-1 flex-shrink-0">
                                ${actionHtml}
                                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ml-1"></i>
                            </div>
                        </div>
                    `;
                });

                chapterHtml += `
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', chapterHtml);
            });
            
            lucide.createIcons();
        }

        // --- Existing JS Functions ---
        function handleEnhancedPractice(chapterTitle, sets) {
            const modalTitle = document.getElementById('enhanced-modal-title');
            const setsList = document.getElementById('enhanced-sets-list');
            modalTitle.textContent = `ã€Š${chapterTitle}ã€‹å¢å¼ºç»ƒä¹ å·`;
            setsList.innerHTML = '';
            sets.forEach((setTitle, index) => {
                const isRecommended = setTitle.includes('ä¸“å®¶æ¨è');
                const element = `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-primary-50 text-primary-600 flex items-center justify-center flex-shrink-0 font-bold text-sm">${String.fromCharCode(65 + index)}</div>
                            <div>
                                <p class="text-sm font-bold text-gray-800">${setTitle}</p>
                                <p class="text-xs ${isRecommended ? 'text-orange-600' : 'text-gray-500'} flex items-center gap-1">${isRecommended ? '<i data-lucide="star" class="w-3.5 h-3.5 fill-orange-400 text-orange-400"></i>ä¸“å®¶æ¨è' : 'é…å¥—å¼ºåŒ–ç»ƒä¹ '}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button class="bg-white text-primary-500 text-xs font-bold px-3 py-1.5 rounded-full border border-primary-300 hover:bg-primary-100 active:scale-95 transition-transform" onclick="viewDetails('${chapterTitle}', 'download', '${setTitle}')">ä¸‹è½½</button>
                            <button class="bg-primary-500 text-white text-xs font-bold px-3 py-1.5 rounded-full hover:bg-primary-600 active:scale-95 transition-transform" onclick="viewDetails('${chapterTitle}', 'view', '${setTitle}')">æŸ¥çœ‹</button>
                        </div>
                    </div>`;
                setsList.insertAdjacentHTML('beforeend', element);
            });
            lucide.createIcons();
            toggleEnhancedPracticeModal();
        }

        function toggleEnhancedPracticeModal() {
            const modal = document.getElementById('enhanced-practice-modal');
            modal.classList.toggle('hidden');
        }

        function togglePersonalizedModal(lessonTitle) {
            const modal = document.getElementById('personalized-modal');
            if (lessonTitle) document.getElementById('personalized-target-title').textContent = lessonTitle;
            modal.classList.toggle('hidden');
        }

        function selectDifficulty(btn, level) {
            const container = document.getElementById('difficulty-selector');
            container.querySelectorAll('button').forEach(b => b.className = 'flex-1 py-2 rounded-lg border border-gray-200 text-sm font-medium text-gray-600 hover:bg-gray-50');
            btn.className = 'flex-1 py-2 rounded-lg border-primary-500 bg-primary-50 text-sm font-bold text-primary-600 ring-1 ring-primary-500';
        }

        function selectCount(btn, count) {
            const container = document.getElementById('count-selector');
            container.querySelectorAll('button').forEach(b => b.className = 'flex-1 py-2 rounded-lg border border-gray-200 text-sm font-medium text-gray-600 hover:bg-gray-50');
            btn.className = 'flex-1 py-2 rounded-lg border-primary-500 bg-primary-50 text-sm font-bold text-primary-600 ring-1 ring-primary-500';
        }

        function generatePractice(type) {
            togglePersonalizedModal();
            alert(type === 'download' ? 'æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆä¸ªæ€§åŒ–ç»ƒä¹ å·PDFï¼Œè¯·ç¨å€™...' : 'æ­£åœ¨è·³è½¬è‡³åœ¨çº¿ç»ƒä¹ é¡µé¢...');
        }

        function toggleTextbookModal() {
            const modal = document.getElementById('textbook-modal');
            modal.classList.toggle('hidden');
        }

        function selectTextbook(version) {
            document.getElementById('current-version').textContent = version;
        }

        function selectGrade(btn, grade) {
            const container = document.getElementById('grade-selector');
            container.querySelectorAll('button').forEach(b => b.className = 'p-2 text-sm rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50');
            btn.className = 'p-2 text-sm font-bold rounded-lg border-2 border-primary-500 bg-primary-50 text-primary-600';
            document.getElementById('current-grade').textContent = grade;
            toggleTextbookModal();
            alert(`å·²åˆ‡æ¢è‡³ ${grade} æ•™æ`);
        }

        function toggleAnalyticsModal() {
            const modal = document.getElementById('analytics-modal');
            modal.classList.toggle('hidden');
        }

        function viewDetails(lesson, action, detail) {
            if (action === 'report') window.location.href = 'jsx_homework_dedtail.html';
            else alert(`${action} ${lesson}`);
        }

        window.onload = function () {
            renderProgress();
            renderLessons(false);
            lucide.createIcons();
        }
    </script>
</body>
</html>
