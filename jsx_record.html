<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>练习中心</title>
    <script src="js/tailwind.min.js"></script>
    <script src="js/lucide.js"></script>
    <link rel="stylesheet" href="js/components/SubjectSwitcher.css">
    <script src="js/components/SubjectSwitcher.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        :root {
            --primary: #09C0D7;
            --primary-light: rgba(9, 192, 215, 0.1);
            --bg-soft: #F8F9FB;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-soft);
            color: #1A1C1E;
        }

        /* 高级感渐变背景 */
        .header-gradient {
            background: linear-gradient(180deg, #FFFFFF 0%, rgba(255, 255, 255, 0) 100%);
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 隐藏滚动条 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 进度条动画 */
        @keyframes progress-loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(250%); }
        }
        .animate-progress-loading { animation: progress-loading 2s infinite linear; }

        /* Tab 激活态平滑过渡 */
        .tab-btn {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 类型 Tab 样式 (内容区) */
        .type-tab {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .type-tab.active {
            background-color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        /* 卡片悬浮微动效 */
        .record-card {
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.03);
        }
        .record-card:active {
            transform: scale(0.985);
            background-color: #FAFAFA;
        }

        /* 磨砂玻璃效果 */
        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
    </style>
</head>

<body class="pb-20 bg-[#f8f9fa]" onload="initPage()">

    <!-- 微信小程序原生导航栏模拟 (Simulated WeChat Native Nav Bar) -->
    <div class="fixed top-0 left-0 right-0 bg-white z-[150] h-[88px] flex flex-col justify-end pb-1 border-b border-gray-50/50">
        <!-- 状态栏占位 (Status Bar Placeholder) -->
        <div class="h-10 w-full flex items-center px-6 justify-between opacity-80">
            <span class="text-[14px] font-medium">9:41</span>
            <div class="flex items-center gap-1.5">
                <i data-lucide="signal" class="w-3.5 h-3.5"></i>
                <i data-lucide="wifi" class="w-3.5 h-3.5"></i>
                <i data-lucide="battery" class="w-4 h-4"></i>
            </div>
        </div>
        
        <!-- 导航功能栏 (Nav Actions Bar) -->
        <div class="relative h-12 flex items-center px-4">
            <!-- 左侧学科切换 -->
            <div class="flex items-end gap-6 h-full pb-1" id="subject-switcher">
                <!-- 由 SubjectSwitcher 组件动态生成 -->
            </div>
            
            <!-- 胶囊按钮 (Capsule Button) -->
            <div class="absolute right-4 flex items-center bg-white border border-gray-200 rounded-full px-3 py-1.5 shadow-sm gap-3 scale-90 origin-right">
                <div class="flex items-center gap-1">
                    <div class="w-1 h-1 rounded-full bg-black"></div>
                    <div class="w-1.5 h-1.5 rounded-full bg-black"></div>
                    <div class="w-1 h-1 rounded-full bg-black"></div>
                </div>
                <div class="w-[1px] h-3.5 bg-gray-200"></div>
                <div class="relative w-5 h-5 flex items-center justify-center">
                    <div class="w-4 h-4 rounded-full border-[1.5px] border-black"></div>
                    <div class="absolute w-1.5 h-1.5 rounded-full bg-black"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 顶部占位 (Spacer for fixed nav) -->
    <div class="h-[88px] bg-white"></div>

    <!-- 1. 类型 Tab 切换 & 筛选 (Combined) -->
    <div class="px-4 sticky top-[88px] z-30 bg-white/90 backdrop-blur-md pb-4 pt-[12px] border-b border-[#F1F5F9] flex items-center gap-2">
        <div class="flex-1 flex items-center justify-between bg-[#F1F5F9] rounded-2xl p-1 border border-[#E2E8F0]/30 shadow-inner" id="tab-container">
            <button onclick="switchTab('consolidation')" class="tab-btn type-tab active flex-1 min-w-[70px] py-2.5 rounded-xl transition-all duration-300 whitespace-nowrap flex flex-col items-center justify-center gap-0.5" data-tab="consolidation">
                <span class="text-[12px] font-black text-[#1E293B]">错题巩固</span>
                <span class="count-label text-[9px] px-1.5 py-0.5 bg-white rounded-full text-[#09C0D7] font-black shadow-sm">0</span>
            </button>
            <button onclick="switchTab('school')" class="tab-btn type-tab flex-1 min-w-[70px] py-2.5 rounded-xl transition-all duration-300 whitespace-nowrap flex flex-col items-center justify-center gap-0.5" data-tab="school">
                <span class="text-[12px] font-bold text-[#64748B]">校本作业</span>
                <span class="count-label text-[9px] px-1.5 py-0.5 bg-transparent rounded-full text-[#64748B] font-medium">0</span>
            </button>
            <button onclick="switchTab('essay')" class="tab-btn type-tab flex-1 min-w-[70px] py-2.5 rounded-xl transition-all duration-300 whitespace-nowrap flex flex-col items-center justify-center gap-0.5" data-tab="essay">
                <span class="text-[12px] font-bold text-[#64748B]">习作</span>
                <span class="count-label text-[9px] px-1.5 py-0.5 bg-transparent rounded-full text-[#64748B] font-medium">0</span>
            </button>
            <button onclick="switchTab('push')" class="tab-btn type-tab flex-1 min-w-[70px] py-2.5 rounded-xl transition-all duration-300 whitespace-nowrap flex flex-col items-center justify-center gap-0.5" data-tab="push">
                <span class="text-[12px] font-bold text-[#64748B]">精准推送</span>
                <span class="count-label text-[9px] px-1.5 py-0.5 bg-transparent rounded-full text-[#64748B] font-medium">0</span>
            </button>
        </div>
        
        <!-- 筛选入口 -->
        <button onclick="toggleFilterModal()" class="flex flex-col items-center justify-center bg-white border border-[#E5E9F0] rounded-2xl w-[60px] h-[58px] shadow-sm active:scale-95 transition-all text-[#475569] shrink-0">
            <i data-lucide="filter" class="w-4 h-4 text-[#09C0D7] mb-0.5"></i>
            <span class="text-[11px] font-black">筛选</span>
        </button>
    </div>

    <!-- 3. 内容列表区域 -->
    <div class="px-4 mt-2 space-y-4 min-h-[400px]" id="list-content">
        <!-- Content will be injected by JS -->
    </div>

    <!-- 筛选弹窗 (Filter Modal) -->
    <div id="filter-modal" class="fixed inset-0 z-[100] hidden">
        <!-- 背景遮罩 -->
        <div onclick="toggleFilterModal()" class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity"></div>
        
        <!-- 弹窗内容 (从底部滑出) -->
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-6 pb-6 transform transition-transform duration-300 translate-y-full flex flex-col max-h-[85vh]" id="filter-panel">
            <!-- 顶部装饰条 -->
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6 shrink-0"></div>
            
            <div class="flex justify-between items-center mb-6 shrink-0">
                <h2 class="text-lg font-black text-gray-800">筛选记录</h2>
                <button onclick="toggleFilterModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-400 active:scale-90 transition-transform">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="space-y-6 overflow-y-auto px-2 no-scrollbar flex-1 pb-4">
                <!-- 1. 年级 -->
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-1 h-3.5 bg-cyan-500 rounded-full"></div>
                        <h3 class="font-bold text-gray-800 text-[13px]">年级</h3>
                    </div>
                    <div class="grid grid-cols-4 gap-2.5" id="filter-grade">
                        <button onclick="selectFilter('grade', '全部')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="全部">全部</button>
                        <button onclick="selectFilter('grade', '一年级')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="一年级">一年级</button>
                        <button onclick="selectFilter('grade', '二年级')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="二年级">二年级</button>
                        <button onclick="selectFilter('grade', '三年级')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="三年级">三年级</button>
                        <button onclick="selectFilter('grade', '四年级')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="四年级">四年级</button>
                        <button onclick="selectFilter('grade', '五年级')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="五年级">五年级</button>
                        <button onclick="selectFilter('grade', '六年级')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="六年级">六年级</button>
                        <button onclick="selectFilter('grade', '七年级')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="七年级">七年级</button>
                        <button onclick="selectFilter('grade', '八年级')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="八年级">八年级</button>
                        <button onclick="selectFilter('grade', '九年级')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="九年级">九年级</button>
                        <button onclick="selectFilter('grade', '高一')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="七年级">高一</button>
                        <button onclick="selectFilter('grade', '高二')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="高二">高二</button>
                        <button onclick="selectFilter('grade', '高三')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="高三">高三</button>
                    </div>
                </div>

                <!-- 2. 完成状态 -->
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-1 h-3.5 bg-cyan-500 rounded-full"></div>
                        <h3 class="font-bold text-gray-800 text-[13px]">完成状态</h3>
                    </div>
                    <div class="grid grid-cols-4 gap-2.5" id="filter-status">
                        <button onclick="selectFilter('status', '全部')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="全部">全部</button>
                        <button onclick="selectFilter('status', 'unsubmitted')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="unsubmitted">未开始</button>
                        <button onclick="selectFilter('status', 'grading')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="grading">进行中</button>
                        <button onclick="selectFilter('status', 'graded')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="graded">已完成</button>
                    </div>
                </div>

                <!-- 3. 时间范围 -->
                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-1 h-3.5 bg-cyan-500 rounded-full"></div>
                        <h3 class="font-bold text-gray-800 text-[13px]">时间范围</h3>
                    </div>
                    <div class="grid grid-cols-4 gap-2.5" id="filter-time">
                        <button onclick="selectFilter('time', '全部')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="全部">全部</button>
                        <button onclick="selectFilter('time', '本周')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="本周">本周</button>
                        <button onclick="selectFilter('time', '本月')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="本月">本月</button>
                        <button onclick="selectFilter('time', '近3个月')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="近3个月">近3个月</button>
                        <button onclick="selectFilter('time', '本学期')" class="filter-btn py-2 rounded-xl text-[11px] font-bold transition-all border" data-value="本学期">本学期</button>
                    </div>
                </div>
            </div>

            <!-- 底部按钮 -->
            <div class="flex gap-3 mt-4 shrink-0">
                <button onclick="resetFilters()" class="flex-1 py-3 bg-rose-50 text-rose-500 rounded-2xl font-bold text-sm active:scale-95 transition-all">重置</button>
                <button onclick="applyFilters()" class="flex-[2.5] bg-gradient-to-r from-cyan-400 to-cyan-500 text-white py-3 rounded-2xl font-black text-sm shadow-[0_8px_20px_-6px_rgba(9,192,215,0.4)] active:scale-95 transition-all">
                    确认筛选 <span id="filter-count-label" class="opacity-70"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- 作业操作选择弹窗 (校本作业未开始状态) -->
    <div id="school-action-modal" class="fixed inset-0 z-[110] hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeSchoolActionModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-[2.5rem] p-6 pb-12 shadow-2xl transform translate-y-full transition-transform duration-300 z-[120]" id="school-action-panel">
            <div class="flex items-center justify-between mb-8">
                <div class="flex flex-col">
                    <h3 class="text-xl font-black text-gray-900 tracking-tight">请选择错题收集方式</h3>
                    <p class="text-[12px] text-gray-400 font-bold mt-1">您可以拍照批改整页作业，或手动标记错题</p>
                </div>
                <button onclick="closeSchoolActionModal()" class="w-10 h-10 bg-gray-50 rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button class="flex flex-col items-center justify-center p-6 bg-[#F0F9FF] border-2 border-transparent hover:border-blue-400 rounded-3xl transition-all group active:scale-[0.98]">
                    <div class="w-16 h-16 bg-blue-500 text-white rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-blue-500/30 group-hover:scale-110 transition-transform">
                        <i data-lucide="camera" class="w-8 h-8"></i>
                    </div>
                    <span class="text-[15px] font-black text-blue-600">拍照批改</span>
                    <span class="text-[10px] text-blue-400 font-bold mt-1">上传作业图片</span>
                </button>

                <button class="flex flex-col items-center justify-center p-6 bg-[#FFF1F2] border-2 border-transparent hover:border-rose-400 rounded-3xl transition-all group active:scale-[0.98]">
                    <div class="w-16 h-16 bg-rose-500 text-white rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-rose-500/30 group-hover:scale-110 transition-transform">
                        <i data-lucide="check-square" class="w-8 h-8"></i>
                    </div>
                    <span class="text-[15px] font-black text-rose-600">标记错题</span>
                    <span class="text-[10px] text-rose-400 font-bold mt-1">手动录入错题</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 z-[60] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closePaymentModal()"></div>

        <!-- Modal Panel -->
        <div class="fixed inset-x-0 bottom-[env(safe-area-inset-bottom)] z-10 w-full overflow-hidden bg-white rounded-t-3xl shadow-2xl sm:inset-0 sm:flex sm:items-center sm:justify-center sm:bg-transparent sm:p-4 sm:rounded-none">
            <div class="relative w-full max-w-md mx-auto bg-white sm:rounded-2xl overflow-hidden flex flex-col max-h-[90vh] animate-in slide-in-from-bottom duration-300">
                
                <!-- Header with Gradient -->
                <div class="relative bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-6 text-white overflow-hidden shrink-0">
                    <div class="absolute top-4 right-4 z-20">
                         <button type="button" class="text-gray-400 hover:text-white transition-colors bg-white/10 rounded-full p-1" onclick="closePaymentModal()">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="relative z-10 mt-2">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="px-2 py-0.5 rounded-full bg-gradient-to-r from-yellow-400 to-orange-500 text-[10px] font-bold text-white shadow-sm flex items-center gap-1">
                                <i data-lucide="crown" class="w-3 h-3"></i> VIP 专属权益
                            </span>
                        </div>
                        <h3 class="text-xl font-bold mb-1">解锁《奥数思维：行程问题进阶》</h3>
                        <p class="text-gray-400 text-xs">获取专家推荐资源，快速提升成绩</p>
                    </div>
                    
                    <!-- Decorative Circles -->
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-white/5 rounded-full blur-2xl"></div>
                    <div class="absolute bottom-0 left-0 w-24 h-24 bg-orange-500/10 rounded-full blur-xl"></div>
                </div>

                <!-- Content Scrollable -->
                <div class="flex-1 overflow-y-auto p-5 space-y-4 no-scrollbar">
                    
                    <!-- Single Purchase Option -->
                    <div class="border border-gray-100 rounded-xl p-4 flex items-center justify-between relative overflow-hidden group hover:border-orange-200 transition-all cursor-pointer bg-gray-50/50 hover:bg-orange-50/30">
                         <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-white shadow-sm border border-gray-100 flex items-center justify-center text-gray-600">
                                 <i data-lucide="file-text" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm">解锁本套试卷</h4>
                                <p class="text-[11px] text-gray-500">仅查看当前试卷错题解析</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="block text-lg font-bold text-orange-600">¥ 3.9</span>
                        </div>
                    </div>

                    <!-- Subscription Options Title -->
                    <div class="flex items-center gap-2 pt-2 pb-1">
                        <div class="h-4 w-1 bg-orange-500 rounded-full"></div>
                        <h4 class="font-bold text-gray-900 text-sm">开通会员畅享无限查看</h4>
                    </div>

                    <!-- Cards Grid -->
                    <div class="grid grid-cols-1 gap-3">
                        
                        <!-- Monthly -->
                        <div class="border-2 border-transparent bg-white rounded-xl p-4 shadow-sm relative overflow-hidden cursor-pointer transition-all hover:shadow-md group" onclick="selectPaymentOption(this)">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h5 class="font-bold text-gray-800">连续包月</h5>
                                        <span class="bg-gray-100 text-gray-600 text-[10px] px-1.5 py-0.5 rounded">灵活订阅</span>
                                    </div>
                                    <div class="mt-2 flex items-baseline gap-1">
                                        <span class="text-2xl font-bold text-orange-600">¥19</span>
                                        <span class="text-xs text-gray-400 line-through">¥30</span>
                                    </div>
                                </div>
                                <div class="w-5 h-5 rounded-full border-2 border-gray-200 flex items-center justify-center group-hover:border-orange-300 transition-colors">
                                    <div class="w-2.5 h-2.5 rounded-full bg-orange-500 opacity-0 transition-opacity check-circle"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Quarterly -->
                        <div class="border-2 border-orange-500 bg-orange-50/30 rounded-xl p-4 shadow-sm relative overflow-hidden cursor-pointer transition-all hover:shadow-md" onclick="selectPaymentOption(this)">
                             <div class="absolute top-0 right-0 bg-gradient-to-bl from-orange-500 to-red-500 text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold shadow-sm z-10">
                                限时 6 折
                            </div>
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h5 class="font-bold text-gray-800">连续包季</h5>
                                    </div>
                                    <div class="mt-2 flex items-baseline gap-1">
                                        <span class="text-2xl font-bold text-orange-600">¥45</span>
                                        <span class="text-xs text-gray-400 line-through">¥75</span>
                                        <span class="text-[10px] text-orange-600 bg-orange-100 px-1 rounded ml-1">¥15/月</span>
                                    </div>
                                </div>
                                <div class="w-5 h-5 rounded-full border-2 border-orange-500 flex items-center justify-center">
                                    <div class="w-2.5 h-2.5 rounded-full bg-orange-500 opacity-100 transition-opacity check-circle"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Annual -->
                        <div class="border-2 border-transparent bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl p-4 shadow-sm relative overflow-hidden cursor-pointer transition-all hover:shadow-md group" onclick="selectPaymentOption(this)">
                            <div class="absolute top-0 left-0 bg-yellow-500 text-white text-[9px] px-1.5 py-0.5 rounded-br-lg font-bold z-10">
                                推荐
                            </div>
                             <div class="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold shadow-sm z-10">
                                立省 ¥200
                            </div>
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h5 class="font-bold text-gray-800">连续包年</h5>
                                    </div>
                                    <div class="mt-2 flex items-baseline gap-1">
                                        <span class="text-2xl font-bold text-orange-600">¥168</span>
                                        <span class="text-xs text-gray-400 line-through">¥368</span>
                                         <span class="text-[10px] text-orange-600 bg-orange-100 px-1 rounded ml-1">¥14/月</span>
                                    </div>
                                </div>
                                 <div class="w-5 h-5 rounded-full border-2 border-gray-200 flex items-center justify-center group-hover:border-orange-300 transition-colors">
                                    <div class="w-2.5 h-2.5 rounded-full bg-orange-500 opacity-0 transition-opacity check-circle"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-[10px] text-gray-400 text-center pt-2">
                        确认支付即代表同意 <a href="#" class="text-blue-500">《会员服务协议》</a> 和 <a href="#" class="text-blue-500">《自动续费协议》</a>
                    </p>
                </div>

                <!-- Footer Action -->
                <div class="p-4 border-t border-gray-100 bg-white shrink-0 safe-area-bottom">
                    <button class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-orange-500/30 active:scale-[0.98] transition-all flex items-center justify-center gap-2" onclick="closePaymentModal()">
                        立即开通 <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentSubject = '语文';
        let currentTab = 'consolidation';
        
        // Filter State
        let activeFilters = {
            grade: '全部',
            status: '全部',
            time: '全部'
        };

        // Mock Data
        const mockData = [
            // 1. 错题巩固 (Consolidation)
            {
                id: 'c1',
                type: 'consolidation',
                subject: '语文',
                title: '第三单元易错字词专项突破',
                status: 'generated',
                date: '2023-10-26',
                count: 15,
                tags: ['包含变式题'],
                source: '错题本组卷'
            },
            {
                id: 'c1_math',
                type: 'consolidation',
                subject: '数学',
                title: '几何图形周长面积综合练习',
                status: 'generated',
                date: '2023-10-25',
                count: 12,
                tags: ['包含变式题'],
                source: '错题本组卷'
            },
            {
                id: 'c2',
                type: 'consolidation',
                subject: '语文',
                title: '第三单元易错字词专项突破',
                status: 'generating', // 生成中
                date: '2023-10-27',
                count: 0,
                tags: ['生成中...'],
                source: '精准练习'
            },
            {
                id: 'c3',
                type: 'consolidation',
                subject: '数学',
                title: '分数乘除法混合运算强化',
                status: 'generating', // 生成中
                date: '2023-10-27',
                count: 0,
                tags: ['生成中...'],
                source: '精准练习'
            },

            // 2. 校本作业 (School) - 主要是数学
            {
                id: 's1',
                type: 'school',
                subject: '数学',
                title: '周末针对性强化：一元一次方程',
                status: 'unsubmitted', // 未提交
                date: '2023-10-27',
                count: 5,
                tags: ['共5题'],
                statusMsg: '请打印后线下作答，完成后拍照批改',
                source: '校本作业'
            },
            {
                id: 's2',
                type: 'school',
                subject: '数学',
                title: '期中复习：几何证明题',
                status: 'grading', // 批阅中
                date: '2023-10-27',
                count: 3,
                tags: ['共3题'],
                statusMsg: '正在智能批改中...',
                source: '校本作业'
            },
            {
                id: 's3',
                type: 'school',
                subject: '数学',
                title: '每日一练：应用题专项',
                status: 'graded', // 已批阅
                score: '92%',
                date: '2023-10-26',
                count: 10,
                tags: ['错题:2 待消灭'],
                statusMsg: '批改已完成',
                source: '校本作业'
            },

            // 3. 习作 (Essay) - 只有语文和英语
            {
                id: 'e1',
                type: 'essay',
                subject: '语文',
                title: '第五单元习作：多彩的活动',
                status: 'unsubmitted',
                date: '2023-10-24',
                count: 1,
                tags: ['三年级上'],
                statusMsg: '请使用配套稿纸书写',
                source: '教材同步'
            },
            {
                id: 'e2',
                type: 'essay',
                subject: '语文',
                title: '第六单元习作：我的奇思妙想',
                status: 'grading',
                date: '2023-10-22',
                count: 1,
                tags: ['四年级上'],
                statusMsg: '正在智能批改中...',
                source: '教材同步'
            },
            {
                id: 'e3',
                type: 'essay',
                subject: '语文',
                title: '第六单元习作：我的奇思妙想',
                status: 'graded',
                score: 'A',
                date: '2023-10-20',
                count: 1,
                tags: ['三年级上'],
                statusMsg: '批改已完成',
                source: '教材同步'
            },

            // 4. 精准推送 (Push)
            {
                id: 'p1',
                type: 'push',
                subject: '数学',
                title: '奥数思维：行程问题进阶',
                status: 'generated',
                date: '2023-10-27',
                count: 8,
                tags: ['专家推荐', '专项练习'],
                difficulty: 4,
                source: 'expert',
                isVip: true
            },
            {
                id: 'p2',
                type: 'push',
                subject: '语文',
                title: '现代文阅读理解技巧点拨',
                status: 'generated',
                date: '2023-10-26',
                count: 3,
                tags: ['教师推荐', '阅读专项'],
                difficulty: 3,
                source: 'teacher',
                isVip: false
            }
        ];

        function initPage() {
            lucide.createIcons();
            
            // 初始化基础组件：学科切换
            new SubjectSwitcher({
                containerId: 'subject-switcher',
                initialSubject: currentSubject,
                onChange: (subject) => {
                    currentSubject = subject;
                    render();
                }
            });

            render();
        }

        // switchSubject 函数已整合到组件回调中，此处仅为兼容原有逻辑（如有其他地方调用）
        function switchSubject(subject) {
            currentSubject = subject;
            render();
        }

        function switchTab(tab) {
            currentTab = tab;
            render();
        }

        function previewPdf(title) {
            window.location.href = `pdf_preview.html?title=${encodeURIComponent(title)}`;
        }

        function render() {
            const container = document.getElementById('list-content');
            container.innerHTML = '';

            // 1. Update Tab Counts & Styles
            const tabs = ['consolidation', 'school', 'essay', 'push'];
            tabs.forEach(tab => {
                const count = mockData.filter(item => item.subject === currentSubject && item.type === tab).length;
                const btn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
                if (btn) {
                    const countLabel = btn.querySelector('.count-label');
                    if (countLabel) countLabel.textContent = count;
                    
                    const span = btn.querySelector('span:first-child');
                    
                    if (tab === currentTab) {
                        btn.className = 'tab-btn type-tab flex-1 min-w-[70px] py-2.5 rounded-xl transition-all duration-300 whitespace-nowrap flex flex-col items-center justify-center gap-0.5 active';
                        if (span) span.className = 'text-[12px] font-black text-[#1E293B]';
                        if (countLabel) countLabel.className = 'count-label text-[9px] px-1.5 py-0.5 bg-white rounded-full text-[#09C0D7] font-black shadow-sm';
                    } else {
                        btn.className = 'tab-btn type-tab flex-1 min-w-[70px] py-2.5 rounded-xl transition-all duration-300 whitespace-nowrap flex flex-col items-center justify-center gap-0.5';
                        if (span) span.className = 'text-[12px] font-bold text-[#64748B]';
                        if (countLabel) countLabel.className = 'count-label text-[9px] px-1.5 py-0.5 bg-transparent rounded-full text-[#64748B] font-medium';
                    }
                }
            });

            // 2. Filter Data
            const filteredData = getFilteredData();

            // Special Case: Essay Tab + Math Subject
            if (currentTab === 'essay' && currentSubject === '数学') {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-gray-400 fade-in">
                        <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-3">
                            <i data-lucide="book-x" class="w-8 h-8 opacity-50"></i>
                        </div>
                        <p class="text-sm">数学学科暂无习作内容</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Empty State
            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-gray-400 fade-in">
                        <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-3">
                            <i data-lucide="inbox" class="w-8 h-8 opacity-50"></i>
                        </div>
                        <p class="text-sm">暂无相关内容</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // 3. Render Items
            filteredData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'record-card bg-white rounded-3xl p-5 shadow-[0_4px_16px_rgba(0,0,0,0.03)] relative overflow-hidden transition-all hover:shadow-lg hover:shadow-cyan-500/5 fade-in flex flex-col';
                card.style.animationDelay = `${index * 0.05}s`;
                
                // Generating State Styling (AI Processing)
                if (item.status === 'generating') {
                    card.className = 'record-card bg-white rounded-[2rem] p-6 shadow-[0_8px_30px_rgb(0,0,0,0.02)] relative overflow-hidden transition-all duration-500 fade-in border border-[#F1F5F9]';
                    card.innerHTML = `
                        <!-- 背景光晕 -->
                        <div class="absolute -right-10 -top-10 w-40 h-40 bg-cyan-50/40 rounded-full blur-3xl animate-pulse"></div>
                        
                        <div class="flex items-start gap-5 relative z-10 mb-6">
                            <!-- AI 动态图标容器 -->
                            <div class="relative">
                                <div class="w-14 h-14 rounded-[1.25rem] bg-gradient-to-br from-cyan-50 to-white flex items-center justify-center relative overflow-hidden border border-cyan-100/30 shadow-sm">
                                    <i data-lucide="sparkles" class="w-7 h-7 text-cyan-500 animate-pulse"></i>
                                    <!-- 旋转边框 -->
                                    <div class="absolute inset-0 border-2 border-transparent border-t-cyan-200 rounded-[1.25rem] animate-spin opacity-40"></div>
                                </div>
                                <!-- 状态指示点 -->
                                <div class="absolute -top-1 -right-1 w-3.5 h-3.5 bg-cyan-400 rounded-full border-2 border-white shadow-sm animate-bounce"></div>
                            </div>

                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="font-black text-[#1E293B] text-[16px] tracking-tight truncate pr-4">${item.title}</h3>
                                    <span class="text-[9px] text-cyan-500 font-black tracking-[0.1em] uppercase bg-cyan-50 px-1.5 py-0.5 rounded-md border border-cyan-100/50 animate-pulse">正在思考</span>
                                </div>
                                
                                <div class="flex items-center gap-2">
                                    <span class="text-[11px] text-[#64748B] font-medium flex items-center gap-1.5">
                                        <i data-lucide="clock" class="w-3.5 h-3.5 opacity-60"></i>
                                        预计还需 1 分钟
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- 进度展示区 -->
                        <div class="bg-[#F8FAFC] rounded-2xl p-4 border border-[#F1F5F9]/60 relative z-10">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-[12px] font-bold text-cyan-600 flex items-center gap-2">
                                    <i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i>
                                    智能组卷中...
                                </span>
                                <span class="text-[11px] font-black text-cyan-500/80 tracking-tighter">45%</span>
                            </div>
                            <div class="w-full h-1.5 bg-white rounded-full overflow-hidden border border-[#F1F5F9]">
                                <div class="h-full bg-gradient-to-r from-cyan-400 via-blue-400 to-cyan-400 rounded-full animate-progress-loading shadow-[0_0_12px_rgba(34,211,238,0.3)]" style="width: 40%"></div>
                            </div>
                        </div>

                        <!-- 底部装饰线 -->
                        <div class="absolute bottom-0 left-0 right-0 h-[2px] bg-gradient-to-r from-transparent via-cyan-100 to-transparent opacity-40"></div>
                    `;
                } else {
                    // 非生成中状态的校本作业增加跳转
                    if (item.type === 'school') {
                        card.classList.add('cursor-pointer');
                        card.onclick = (e) => {
                            // 如果点击的是按钮，不触发卡片跳转
                            if (e.target.closest('button')) return;
                            
                            if (item.status === 'unsubmitted') goToHomeworkDetail('uncollected');
                            else if (item.status === 'grading') goToHomeworkDetail('grading');
                            else if (item.status === 'graded') goToHomeworkDetail('graded');
                        };
                    }

                    // Icons and Colors
                    let icon = 'file-text';
                    let iconBg = 'bg-[#E0F7FA] text-[#00ACC1]';
                    if (item.type === 'essay') {
                        icon = 'pen-tool';
                        iconBg = 'bg-[#E8F5E9] text-[#43A047]';
                    } else if (item.type === 'school') {
                        icon = 'book-open';
                        iconBg = 'bg-[#E3F2FD] text-[#1E88E5]';
                    } else if (item.isVip) {
                        icon = 'crown';
                        iconBg = 'bg-gradient-to-br from-[#FFD54F] to-[#FB8C00] text-white';
                    }

                    // Header Tags
                    const topRightTags = [];
                    const displayTags = (item.tags || []).filter(tag => {
                        if (tag === '包含变式题' || tag === '专家推荐' || tag === '教师推荐') {
                            topRightTags.push(tag);
                            return false;
                        }
                        // 过滤掉已经在 infoBar 中展示的“共X题”标签
                        if (/^共\d+题$/.test(tag)) return false;
                        return true;
                    });

                    const tagHtml = displayTags.map(tag => {
                        let tagClass = 'bg-[#F1F5F9] text-[#64748B]';
                        if (tag.includes('专项') || tag.includes('错题')) tagClass = 'bg-[#FFF1F2] text-[#E11D48] border border-[#FFE4E6]';
                        if (tag.includes('工整')) tagClass = 'bg-[#ECFDF5] text-[#059669] border border-[#D1FAE5]';
                        if (tag.includes('同步')) tagClass = 'bg-[#EFF6FF] text-[#2563EB] border border-[#DBEAFE]';
                        return `<span class="${tagClass} text-[10px] px-2.5 py-0.5 rounded-full font-bold tracking-tight">${tag}</span>`;
                    }).join('');

                    // Difficulty Stars
                    let difficultyHtml = '';
                    if (item.type === 'push' && item.difficulty) {
                        difficultyHtml = `
                            <div class="flex items-center gap-0.5 ml-1">
                                ${Array.from({ length: 5 }).map((_, i) => `
                                    <i data-lucide="star" class="w-3 h-3 ${i < item.difficulty ? 'text-orange-400 fill-orange-400' : 'text-gray-200'}"></i>
                                `).join('')}
                            </div>
                        `;
                    }

                    const topRightTagHtml = topRightTags.map(tag => {
                        let tagClass = 'bg-orange-50 text-orange-600 border border-orange-100';
                        if (tag === '包含变式题') tagClass = 'bg-cyan-50 text-cyan-600 border border-cyan-100';
                        return `<span class="${tagClass} text-[10px] px-2 py-0.5 rounded-bl-xl rounded-tr-none font-black absolute top-0 right-0">${tag}</span>`;
                    }).join('');

                    // Score Display
                    const scoreHtml = item.score ? `
                        <div class="flex flex-col items-end bg-[#F8FAFC] p-2 rounded-2xl border border-[#F1F5F9] min-w-[64px]">
                            <div class="flex items-baseline gap-0.5">
                                <span class="text-[24px] font-black text-[#1E293B] leading-none tracking-tighter">${item.score}</span>
                                <span class="text-[9px] text-[#94A3B8] font-bold uppercase tracking-tighter ml-0.5"></span>
                            </div>
                            <div class="w-full h-1 bg-white rounded-full mt-2 overflow-hidden border border-[#F1F5F9]">
                                <div class="h-full bg-gradient-to-r from-[#10B981] to-[#34D399] rounded-full shadow-[0_0_8px_rgba(16,185,129,0.2)]" style="width: ${item.score}%"></div>
                            </div>
                        </div>
                    ` : '';

                    // Info Bar (Generation time and count)
                    let infoBar = '';
                    let timeLabel = '生成时间';
                    if (item.type === 'school') timeLabel = '作业时间';
                    if (item.type === 'essay') timeLabel = '作业时间';

                    if (item.status !== 'generating') {
                        const countHtml = item.type !== 'essay' ? `
                                <div class="flex items-center gap-1.5">
                                    <i data-lucide="list-checks" class="w-3.5 h-3.5 opacity-60"></i>
                                    共 ${item.count} 题
                                </div>
                        ` : '';

                        infoBar = `
                            <div class="flex items-center gap-4 mb-4 text-[11px] text-gray-400 font-medium">
                                <div class="flex items-center gap-1.5">
                                    <i data-lucide="calendar" class="w-3.5 h-3.5 opacity-60"></i>
                                    ${timeLabel}：${item.date}
                                </div>
                                ${countHtml}
                            </div>
                        `;
                    }

                    // Status Bar Logic
                    let statusBar = '';
                    if (item.statusMsg) {
                        // 已完成状态的校本作业和习作不展示中间的状态栏
                        const isGradedSchoolOrEssay = (item.type === 'school' || item.type === 'essay') && item.status === 'graded';
                        
                        if (!isGradedSchoolOrEssay) {
                            let barClass = 'bg-[#F8FAFC] text-[#64748B] border border-[#F1F5F9]';
                            let badgeClass = 'text-[#E11D48] bg-[#FFF1F2] border border-[#FFE4E6]';
                            let badgeText = '未开始';
                            let iconHtml = '<i data-lucide="circle-dashed" class="w-3.5 h-3.5"></i>';

                            if (item.status === 'grading') {
                                barClass = 'bg-[#F0F9FF] text-[#0284C7] border border-[#E0F2FE]';
                                badgeClass = 'text-blue-500 bg-blue-50 border border-blue-200';
                                badgeText = '进行中';
                                iconHtml = '<i data-lucide="refresh-cw" class="w-3.5 h-3.5 animate-spin"></i>';
                            } else if (item.status === 'graded') {
                                barClass = 'bg-emerald-50/50 text-emerald-600 border border-emerald-100/50';
                                badgeClass = 'text-emerald-600 bg-emerald-50 border border-emerald-200';
                                badgeText = '已完成';
                                iconHtml = '<i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i>';
                            }

                            statusBar = `
                                <div class="${barClass} rounded-2xl p-3.5 flex justify-between items-center mb-5 backdrop-blur-sm">
                                    <div class="text-[12px] flex items-center gap-2.5 font-bold">
                                        ${iconHtml} ${item.statusMsg}
                                    </div>
                                    <div class="${badgeClass} px-2.5 py-1 rounded-xl text-[10px] font-black tracking-wider uppercase">
                                        ${badgeText}
                                    </div>
                                </div>
                            `;
                        }
                    }

                    // Action Buttons Logic
                    let actionHtml = '';
                    if (item.type === 'essay') {
                        if (item.status === 'unsubmitted') {
                            actionHtml = `
                                <button class="w-full py-3.5 bg-[#09C0D7] hover:bg-[#08aebd] text-white rounded-2xl text-[13px] font-black shadow-[0_8px_24px_-6px_rgba(9,192,215,0.4)] active:scale-[0.98] transition-all flex items-center justify-center gap-2.5">
                                    <i data-lucide="camera" class="w-4.5 h-4.5"></i> 拍照批改
                                </button>
                            `;
                        } else {
                            actionHtml = `
                                <div class="flex gap-3">
                                    <button class="flex-[0.4] py-3.5 border border-gray-100 text-gray-500 hover:bg-gray-50 rounded-2xl text-[13px] font-bold active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                                        <i data-lucide="rotate-cw" class="w-4 h-4"></i> 重新提交
                                    </button>
                                    <button class="flex-1 py-3.5 bg-[#09C0D7] hover:bg-[#08aebd] text-white rounded-2xl text-[13px] font-black shadow-[0_8px_24px_-6px_rgba(9,192,215,0.4)] active:scale-[0.98] transition-all flex items-center justify-center gap-2.5">
                                        <i data-lucide="${item.status === 'grading' ? 'eye' : 'file-bar-chart'}" class="w-4.5 h-4.5"></i> ${item.status === 'grading' ? '查看详情' : '查看评价'}
                                    </button>
                                </div>
                            `;
                        }
                    } else if (item.type === 'school') {
                        if (item.status === 'unsubmitted') {
                            actionHtml = `
                                <button onclick="openSchoolActionModal()" class="w-full py-3.5 bg-[#09C0D7] hover:bg-[#08aebd] text-white rounded-2xl text-[13px] font-black shadow-[0_8px_24px_-6px_rgba(9,192,215,0.4)] active:scale-[0.98] transition-all flex items-center justify-center gap-2.5">
                                    <i data-lucide="pencil-line" class="w-4.5 h-4.5"></i> 拍照批改/标记错题
                                </button>
                            `;
                        } else if (item.status === 'grading') {
                            actionHtml = `
                                <button onclick="goToHomeworkDetail('grading')" class="w-full py-3.5 bg-white border border-[#09C0D7]/30 text-[#09C0D7] rounded-2xl text-[13px] font-black active:scale-[0.98] transition-all flex items-center justify-center gap-2.5 shadow-sm">
                                    <i data-lucide="glasses" class="w-4.5 h-4.5"></i> 查看详情
                                </button>
                            `;
                        } else {
                            actionHtml = `
                                <div class="flex gap-3">
                                    <button onclick="goToHomeworkDetail('graded')" class="flex-[0.4] py-3.5 border border-gray-100 text-gray-500 hover:bg-gray-50 rounded-2xl text-[13px] font-bold active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                                        <i data-lucide="history" class="w-4 h-4"></i> 错题巩固
                                    </button>
                                    <button onclick="goToHomeworkDetail('graded')" class="flex-1 py-3.5 bg-[#09C0D7] hover:bg-[#08aebd] text-white rounded-2xl text-[13px] font-black shadow-[0_8px_24px_-6px_rgba(9,192,215,0.4)] active:scale-[0.98] transition-all flex items-center justify-center gap-2.5">
                                        <i data-lucide="check-square" class="w-4.5 h-4.5"></i> 查看评价
                                    </button>
                                </div>
                            `;
                        }
                    } else if (item.isVip) {
                        actionHtml = `
                            <button onclick="openPaymentModal()" class="w-full py-3.5 bg-gradient-to-r from-amber-400 to-orange-500 text-white rounded-2xl text-[13px] font-black shadow-[0_8px_24px_-6px_rgba(245,158,11,0.4)] active:scale-[0.98] transition-all flex items-center justify-center gap-2.5">
                                <i data-lucide="sparkles" class="w-4.5 h-4.5"></i> 开通 VIP 解锁全部功能
                            </button>
                        `;
                    } else {
                        // Consolidation & Push
                        actionHtml = `
                            <div class="flex gap-2">
                                <button onclick="previewPdf('${item.title.replace(/'/g, "\\'")}')" class="flex-1 py-2.5 border border-gray-100 text-gray-600 hover:bg-gray-50 rounded-xl text-[12px] font-bold active:scale-[0.98] transition-all flex items-center justify-center gap-1.5">
                                    <i data-lucide="eye" class="w-3.5 h-3.5"></i> 预览下载
                                </button>
                                <button class="flex-1 py-2.5 border border-gray-100 text-gray-600 hover:bg-gray-50 rounded-xl text-[12px] font-bold active:scale-[0.98] transition-all flex items-center justify-center gap-1.5">
                                    <i data-lucide="camera" class="w-3.5 h-3.5"></i> 拍照批改
                                </button>
                                <button class="flex-1 py-2.5 bg-[#09C0D7] hover:bg-[#08aebd] text-white rounded-xl text-[12px] font-black shadow-[0_4px_12px_-3px_rgba(9,192,215,0.3)] active:scale-[0.98] transition-all flex items-center justify-center gap-1.5">
                                    <i data-lucide="pencil" class="w-3.5 h-3.5"></i> 在线作答
                                </button>
                            </div>
                        `;
                    }

                    card.innerHTML = `
                        ${topRightTagHtml}
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-start gap-4 flex-1">
                                <div class="w-13 h-13 rounded-[1.25rem] ${iconBg} flex items-center justify-center flex-shrink-0 shadow-sm border border-white/20">
                                    <i data-lucide="${icon}" class="w-6.5 h-6.5"></i>
                                </div>
                                <div class="flex-1 min-w-0 pr-2">
                                    <h3 class="font-black text-gray-900 text-[16px] mb-2 line-clamp-2 leading-[1.3] tracking-tight">${item.title}</h3>
                                    <div class="flex flex-wrap items-center gap-2">
                                        ${tagHtml}
                                        ${difficultyHtml}
                                    </div>
                                </div>
                            </div>
                            ${scoreHtml}
                        </div>
                        
                        ${infoBar}
                        ${statusBar}
                        <div class="mt-auto">
                            ${actionHtml}
                        </div>
                    `;
                }

                container.appendChild(card);
            });

            lucide.createIcons();
        }

        function getSourceName(item) {
            if (item.type === 'consolidation') return item.source;
            if (item.type === 'school') return '校内作业';
            if (item.type === 'essay') return '课本习作';
            if (item.type === 'push') {
                if (item.source === 'expert') return '专家团队';
                if (item.source === 'teacher') return '任课老师';
                return '智能算法';
            }
            return '系统生成';
        }

        // 支付弹窗逻辑
        function openPaymentModal() {
            const modal = document.getElementById('payment-modal');
            modal.classList.remove('hidden');
            lucide.createIcons();
            // 通知父页面弹窗已打开，提高 iframe 层级
            if (window.parent) {
                window.parent.postMessage({ type: 'SET_MODAL_ACTIVE', active: true }, '*');
            }
        }

        function closePaymentModal() {
            document.getElementById('payment-modal').classList.add('hidden');
            // 通知父页面弹窗已关闭，恢复 iframe 层级
            if (window.parent) {
                window.parent.postMessage({ type: 'SET_MODAL_ACTIVE', active: false }, '*');
            }
        }

        // 校本作业跳转逻辑
        function goToHomeworkDetail(state) {
            window.location.href = `jsx_homework_dedtail.html?state=${state}`;
        }

        // 校本作业操作弹窗逻辑
        function openSchoolActionModal() {
            const modal = document.getElementById('school-action-modal');
            const panel = document.getElementById('school-action-panel');
            
            modal.classList.remove('hidden');
            // Force layout for transition
            setTimeout(() => {
                panel.classList.remove('translate-y-full');
                panel.classList.add('translate-y-0');
            }, 10);
            
            if (window.parent) {
                window.parent.postMessage({ type: 'SET_MODAL_ACTIVE', active: true }, '*');
            }
            lucide.createIcons();
        }

        function closeSchoolActionModal() {
            const modal = document.getElementById('school-action-modal');
            const panel = document.getElementById('school-action-panel');
            
            panel.classList.add('translate-y-full');
            panel.classList.remove('translate-y-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
            
            if (window.parent) {
                window.parent.postMessage({ type: 'SET_MODAL_ACTIVE', active: false }, '*');
            }
        }

        function selectPaymentOption(element) {
            // Reset all options visual state
            const container = element.parentElement;
            const allOptions = container.children;
            
            for (let opt of allOptions) {
                // Remove active classes
                opt.classList.remove('border-orange-500', 'bg-orange-50/30');
                
                // Add default classes
                if(opt.innerHTML.includes('连续包年')) {
                    // Keep gradient for annual
                     opt.classList.add('border-transparent');
                } else {
                     opt.classList.add('border-transparent', 'bg-white');
                }

                // Reset Check Circle
                const check = opt.querySelector('.check-circle');
                if(check) {
                    check.classList.remove('opacity-100');
                    check.classList.add('opacity-0');
                }
                
                // Reset Ring
                const ring = opt.querySelector('.w-5.h-5');
                if(ring) {
                    ring.classList.remove('border-orange-500');
                    ring.classList.add('border-gray-200');
                }
            }

            // Activate selected
            element.classList.remove('border-transparent', 'bg-white');
            element.classList.add('border-orange-500', 'bg-orange-50/30');
            
            // Activate Check Circle
            const check = element.querySelector('.check-circle');
            if(check) {
                check.classList.remove('opacity-0');
                check.classList.add('opacity-100');
            }

            // Activate Ring
            const ring = element.querySelector('.w-5.h-5');
            if(ring) {
                ring.classList.remove('border-gray-200');
                ring.classList.add('border-orange-500');
            }
        }
        
        // 筛选逻辑
        function toggleFilterModal() {
            const modal = document.getElementById('filter-modal');
            const panel = document.getElementById('filter-panel');
            
            if (modal.classList.contains('hidden')) {
                // Open
                modal.classList.remove('hidden');
                // Force layout for transition
                setTimeout(() => {
                    panel.classList.remove('translate-y-full');
                    panel.classList.add('translate-y-0');
                }, 10);
                
                // Update UI state based on current filters
                updateFilterUI();
                updateFilterCountLabel();
                
                if (window.parent) {
                    window.parent.postMessage({ type: 'SET_MODAL_ACTIVE', active: true }, '*');
                }
            } else {
                // Close
                panel.classList.add('translate-y-full');
                panel.classList.remove('translate-y-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
                
                if (window.parent) {
                    window.parent.postMessage({ type: 'SET_MODAL_ACTIVE', active: false }, '*');
                }
            }
        }

        function selectFilter(type, value) {
            activeFilters[type] = value;
            updateFilterUI();
            updateFilterCountLabel();
        }

        function updateFilterUI() {
            // Update buttons in each group
            Object.keys(activeFilters).forEach(type => {
                const group = document.getElementById(`filter-${type}`);
                if (!group) return;
                
                const buttons = group.querySelectorAll('.filter-btn');
                buttons.forEach(btn => {
                    const isSelected = btn.getAttribute('data-value') === activeFilters[type];
                    if (isSelected) {
                        btn.classList.add('bg-cyan-50', 'text-cyan-600', 'border-cyan-200');
                        btn.classList.remove('text-gray-500', 'bg-white', 'border-gray-100');
                    } else {
                        btn.classList.remove('bg-cyan-50', 'text-cyan-600', 'border-cyan-200');
                        btn.classList.add('text-gray-500', 'bg-white', 'border-gray-100');
                    }
                });
            });
        }

        function updateFilterCountLabel() {
            const filtered = getFilteredData();
            document.getElementById('filter-count-label').innerText = `(共 ${filtered.length} 条)`;
        }

        function resetFilters() {
            activeFilters = {
                grade: '全部',
                status: '全部',
                time: '全部'
            };
            updateFilterUI();
            updateFilterCountLabel();
        }

        function applyFilters() {
            render();
            toggleFilterModal();
        }

        function getFilteredData() {
            return mockData.filter(item => {
                // 1. Tab & Subject (Existing logic)
                if (item.type !== currentTab) return false;
                if (item.subject !== currentSubject) return false;

                // 2. Grade Filter
                if (activeFilters.grade !== '全部') {
                    // Check tags or title for grade
                    const gradeStr = activeFilters.grade;
                    const matchesGrade = (item.tags || []).some(t => t.includes(gradeStr)) || item.title.includes(gradeStr);
                    if (!matchesGrade) return false;
                }

                // 3. Status Filter
                if (activeFilters.status !== '全部') {
                    if (item.status !== activeFilters.status) return false;
                }

                // 4. Time Filter
                if (activeFilters.time !== '全部') {
                    const now = new Date();
                    const itemDate = new Date(item.date);
                    const diffDays = (now - itemDate) / (1000 * 60 * 60 * 24);

                    if (activeFilters.time === '本周' && diffDays > 7) return false;
                    if (activeFilters.time === '本月' && diffDays > 30) return false;
                    if (activeFilters.time === '近3个月' && diffDays > 90) return false;
                }

                return true;
            });
        }
    </script>
</body>
</html>